{% extends 'layout.html' %}

{% block title %}Productos - Green-POS{% endblock %}

{% block page_title %}Productos{% endblock %}

{% block page_actions %}
{% if current_user.role == 'admin' %}
<a href="{{ url_for('products.merge') }}" class="btn btn-warning me-2">
    <i class="bi bi-arrow-left-right"></i> Consolidar Productos
</a>
{% endif %}
<a href="{{ url_for('products.new') }}" class="btn btn-primary" id="newProductBtn">
    <i class="bi bi-plus-circle"></i> Nuevo Producto
</a>
{% endblock %}

{% block extra_css %}
<style>
    .table thead th a {
        display: block;
        color: inherit;
        user-select: none;
    }
    .table thead th a:hover {
        background-color: rgba(0, 0, 0, 0.05);
        cursor: pointer;
    }
    .table thead th {
        position: relative;
    }
    .table thead th a i {
        font-size: 0.8em;
        margin-left: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4" id="productsSearchCard">
    <div class="card-body">
        <form action="{{ url_for('products.list') }}" method="get" id="productsSearchForm">
            <div class="row g-3">
                <!-- Búsqueda por texto -->
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" name="query" class="form-control" id="productSearchInput" 
                               placeholder="Buscar por nombre o código..." value="{{ query }}">
                        <button class="btn btn-primary" type="submit" id="searchProductBtn">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                        {% if query or supplier_id %}
                            <a href="{{ url_for('products.list') }}" class="btn btn-outline-secondary" id="clearSearchBtn">
                                <i class="bi bi-x-circle"></i> Limpiar todo
                            </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Filtro por Proveedor -->
                <div class="col-md-4">
                    <div class="input-group">
                        <label class="input-group-text" for="supplierFilter">
                            <i class="bi bi-truck"></i> Proveedor
                        </label>
                        <select name="supplier_id" class="form-select" id="supplierFilterSelect" onchange="this.form.submit()">
                            <option value="">-- Todos los Proveedores --</option>
                            {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}" {% if supplier_id == supplier.id|string %}selected{% endif %}>
                                    {{ supplier.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Información de filtros activos -->
                {% if supplier_id %}
                <div class="col-12">
                    <div class="alert alert-info py-2 mb-0" role="alert">
                        <i class="bi bi-funnel"></i> 
                        Filtrando por proveedor: <strong>{{ suppliers|selectattr('id', 'equalto', supplier_id|int)|map(attribute='name')|first }}</strong>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Campos ocultos para mantener el orden -->
            <input type="hidden" name="sort_by" value="{{ sort_by }}">
            <input type="hidden" name="sort_order" value="{{ sort_order }}">
        </form>
    </div>
</div>

<div class="card" id="productsTableCard">
    <div class="card-body">
        {% if products %}
            <div class="table-responsive" id="productsTableContainer">
                <table class="table table-hover" id="productsTable">
                    <thead id="productsTableHead">
                        <tr>
                            <th>
                                <a href="{{ url_for('products.list', query=query, supplier_id=supplier_id, sort_by='code', sort_order='desc' if sort_by == 'code' and sort_order == 'asc' else 'asc') }}" 
                                   class="text-decoration-none text-dark" id="sortByCode">
                                    Código 
                                    {% if sort_by == 'code' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('products.list', query=query, supplier_id=supplier_id, sort_by='name', sort_order='desc' if sort_by == 'name' and sort_order == 'asc' else 'asc') }}" 
                                   class="text-decoration-none text-dark" id="sortByName">
                                    Nombre 
                                    {% if sort_by == 'name' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('products.list', query=query, supplier_id=supplier_id, sort_by='category', sort_order='desc' if sort_by == 'category' and sort_order == 'asc' else 'asc') }}" 
                                   class="text-decoration-none text-dark" id="sortByCategory">
                                    Categoría 
                                    {% if sort_by == 'category' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('products.list', query=query, supplier_id=supplier_id, sort_by='purchase_price', sort_order='desc' if sort_by == 'purchase_price' and sort_order == 'asc' else 'asc') }}" 
                                   class="text-decoration-none text-dark" id="sortByPurchasePrice">
                                    Precio Compra 
                                    {% if sort_by == 'purchase_price' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('products.list', query=query, supplier_id=supplier_id, sort_by='sale_price', sort_order='desc' if sort_by == 'sale_price' and sort_order == 'asc' else 'asc') }}" 
                                   class="text-decoration-none text-dark" id="sortBySalePrice">
                                    Precio Venta 
                                    {% if sort_by == 'sale_price' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('products.list', query=query, supplier_id=supplier_id, sort_by='stock', sort_order='desc' if sort_by == 'stock' and sort_order == 'asc' else 'asc') }}" 
                                   class="text-decoration-none text-dark" id="sortByStock">
                                    Stock 
                                    {% if sort_by == 'stock' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('products.list', query=query, supplier_id=supplier_id, sort_by='sales_count', sort_order='desc' if sort_by == 'sales_count' and sort_order == 'asc' else 'asc') }}" 
                                   class="text-decoration-none text-dark" id="sortBySalesCount">
                                    Vendidos 
                                    {% if sort_by == 'sales_count' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th id="productsActionsHeader">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        {% for product in products %}
                            <tr id="productRow-{{ product.id }}">
                                <td id="productCode-{{ product.id }}">{{ product.code }}</td>
                                <td id="productName-{{ product.id }}">{{ product.name }}</td>
                                <td id="productCategory-{{ product.id }}">{{ product.category }}</td>
                                <td id="productPurchasePrice-{{ product.id }}">{{ product.purchase_price | currency_co }}</td>
                                <td id="productSalePrice-{{ product.id }}">{{ product.sale_price | currency_co }}</td>
                                <td>
                                    {% set badge_class = 'success' %}
                                    {% if product.stock == 0 %}
                                        {% set badge_class = 'danger' %}
                                    {% elif product.stock <= 3 %}
                                        {% set badge_class = 'warning' %}
                                    {% endif %}
                                    <span class="badge bg-{{ badge_class }}" id="productStock-{{ product.id }}">{{ product.stock }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info" id="productSales-{{ product.id }}">{{ product.sales_count or 0 }}</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" id="productActions-{{ product.id }}">
                                        <a href="{{ url_for('products.stock_history', id=product.id, query=query, sort_by=sort_by, sort_order=sort_order, supplier_id=supplier_id) }}" 
                                           class="btn btn-outline-info" 
                                           id="historyBtn-{{ product.id }}"
                                           title="Ver historial de inventario">
                                            <i class="bi bi-clock-history"></i>
                                        </a>
                                        <a href="{{ url_for('products.edit', id=product.id, query=query, sort_by=sort_by, sort_order=sort_order, supplier_id=supplier_id) }}" 
                                           class="btn btn-outline-primary"
                                           id="editProductBtn-{{ product.id }}"
                                           title="Editar producto">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-danger" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#productDeleteModal" 
                                                data-id="{{ product.id }}"
                                                data-name="{{ product.name }}"
                                                id="deleteProductBtn-{{ product.id }}"
                                                title="Eliminar producto">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info" id="productsEmptyState">
                {% if query %}
                    No se encontraron productos para "{{ query }}".
                {% else %}
                    No hay productos registrados. <a href="{{ url_for('products.new') }}" id="createFirstProductLink">Crear el primer producto</a>.
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="productDeleteModal" tabindex="-1">
    <div class="modal-dialog" id="productDeleteModalDialog">
        <div class="modal-content" id="productDeleteModalContent">
            <div class="modal-header" id="productDeleteModalHeader">
                <h5 class="modal-title" id="productDeleteModalTitle">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="productDeleteModalCloseBtn"></button>
            </div>
            <div class="modal-body" id="productDeleteModalBody">
                <p>¿Estás seguro de que deseas eliminar el producto <strong id="deleteProductName"></strong>?</p>
                <p class="text-danger">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer" id="productDeleteModalFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelDeleteProductBtn">Cancelar</button>
                <form id="deleteProductForm" action="" method="post">
                    <!-- Campos ocultos para preservar estado de navegación -->
                    <input type="hidden" name="return_query" value="{{ query }}">
                    <input type="hidden" name="return_sort_by" value="{{ sort_by }}">
                    <input type="hidden" name="return_sort_order" value="{{ sort_order }}">
                    <input type="hidden" name="return_supplier_id" value="{{ supplier_id }}">
                    
                    <button type="submit" class="btn btn-danger" id="confirmDeleteProductBtn">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set up delete modal
    document.addEventListener('DOMContentLoaded', function() {
        const deleteModal = document.getElementById('productDeleteModal');
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const id = button.dataset.id;
            const name = button.dataset.name;
            
            document.getElementById('deleteProductName').textContent = name;
            document.getElementById('deleteProductForm').action = "{{ url_for('products.delete', id=0) }}".replace('0', id);
        });
    });
</script>
{% endblock %}
