{% extends 'layout.html' %}

{% block title %}Productos - Green-POS{% endblock %}

{% block page_title %}Productos{% endblock %}

{% block page_actions %}
<a href="{{ url_for('product_new') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> Nuevo Producto
</a>
{% endblock %}

{% block extra_css %}
<style>
    .table thead th a {
        display: block;
        color: inherit;
        user-select: none;
    }
    .table thead th a:hover {
        background-color: rgba(0, 0, 0, 0.05);
        cursor: pointer;
    }
    .table thead th {
        position: relative;
    }
    .table thead th a i {
        font-size: 0.8em;
        margin-left: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <form action="{{ url_for('product_list') }}" method="get">
            <div class="input-group">
                <input type="text" name="query" class="form-control" placeholder="Buscar por nombre o código..." value="{{ query }}">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i> Buscar
                </button>
                {% if query %}
                    <a href="{{ url_for('product_list') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if products %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>
                                <a href="{{ url_for('product_list', query=query, sort_by='code', sort_order='desc' if sort_by == 'code' and sort_order == 'asc' else 'asc') }}" class="text-decoration-none text-dark">
                                    Código 
                                    {% if sort_by == 'code' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('product_list', query=query, sort_by='name', sort_order='desc' if sort_by == 'name' and sort_order == 'asc' else 'asc') }}" class="text-decoration-none text-dark">
                                    Nombre 
                                    {% if sort_by == 'name' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('product_list', query=query, sort_by='category', sort_order='desc' if sort_by == 'category' and sort_order == 'asc' else 'asc') }}" class="text-decoration-none text-dark">
                                    Categoría 
                                    {% if sort_by == 'category' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('product_list', query=query, sort_by='purchase_price', sort_order='desc' if sort_by == 'purchase_price' and sort_order == 'asc' else 'asc') }}" class="text-decoration-none text-dark">
                                    Precio Compra 
                                    {% if sort_by == 'purchase_price' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('product_list', query=query, sort_by='sale_price', sort_order='desc' if sort_by == 'sale_price' and sort_order == 'asc' else 'asc') }}" class="text-decoration-none text-dark">
                                    Precio Venta 
                                    {% if sort_by == 'sale_price' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('product_list', query=query, sort_by='stock', sort_order='desc' if sort_by == 'stock' and sort_order == 'asc' else 'asc') }}" class="text-decoration-none text-dark">
                                    Stock 
                                    {% if sort_by == 'stock' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('product_list', query=query, sort_by='sales_count', sort_order='desc' if sort_by == 'sales_count' and sort_order == 'asc' else 'asc') }}" class="text-decoration-none text-dark">
                                    Vendidos 
                                    {% if sort_by == 'sales_count' %}
                                        <i class="bi bi-arrow-{{ 'down' if sort_order == 'desc' else 'up' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                            <tr>
                                <td>{{ product.code }}</td>
                                <td>{{ product.name }}</td>
                                <td>{{ product.category }}</td>
                                <td>{{ product.purchase_price | currency_co }}</td>
                                <td>{{ product.sale_price | currency_co }}</td>
                                <td>
                                    {% set badge_class = 'success' %}
                                    {% if product.stock < 0 %}
                                        {% set badge_class = 'danger' %}
                                    {% elif product.stock == 0 %}
                                        {% set badge_class = 'warning' %}
                                    {% endif %}
                                    <span class="badge bg-{{ badge_class }}">{{ product.stock }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ product.sales_count or 0 }}</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('product_stock_history', id=product.id) }}" 
                                           class="btn btn-outline-info" 
                                           title="Ver historial de inventario">
                                            <i class="bi bi-clock-history"></i>
                                        </a>
                                        <a href="{{ url_for('product_edit', id=product.id) }}" 
                                           class="btn btn-outline-primary"
                                           title="Editar producto">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-danger" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteModal" 
                                                data-id="{{ product.id }}"
                                                data-name="{{ product.name }}"
                                                title="Eliminar producto">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                {% if query %}
                    No se encontraron productos para "{{ query }}".
                {% else %}
                    No hay productos registrados. <a href="{{ url_for('product_new') }}">Crear el primer producto</a>.
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar el producto <strong id="productName"></strong>?</p>
                <p class="text-danger">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" action="" method="post">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set up delete modal
    document.addEventListener('DOMContentLoaded', function() {
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const id = button.dataset.id;
            const name = button.dataset.name;
            
            document.getElementById('productName').textContent = name;
            document.getElementById('deleteForm').action = "{{ url_for('product_delete', id=0) }}".replace('0', id);
        });
    });
</script>
{% endblock %}
