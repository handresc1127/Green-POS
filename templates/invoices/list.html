{% extends 'layout.html' %}

{% block title %}Ventas ({{ setting.document_label }}s) - Green-POS{% endblock %}

{% block page_title %}Ventas ({{ setting.document_label }}s){% endblock %}

{% block page_actions %}
<a href="{{ url_for('invoices.new') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> Nueva Venta
</a>
{% endblock %}

{% block extra_css %}
<style>
    .card-header .btn-link {
        transition: all 0.3s ease;
    }
    .card-header .btn-link:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    .collapse-icon {
        transition: transform 0.3s ease;
        display: inline-block;
    }
    .collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <form action="{{ url_for('invoices.list') }}" method="get">
            <div class="input-group">
                <input type="text" name="query" class="form-control"
                    placeholder="Buscar por n√∫mero, cliente o documento..." value="{{ query }}">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i> Buscar
                </button>
                {% if query %}
                <a href="{{ url_for('invoices.list') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Limpiar
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if invoices_by_date %}
        {% for date, invoices in invoices_by_date.items() %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <button class="btn btn-link text-decoration-none text-dark w-100 text-start d-flex justify-content-between align-items-center p-0{{ ' collapsed' if loop.index != 1 }}" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapse-{{ loop.index }}" 
                            aria-expanded="{{ 'true' if loop.index == 1 else 'false' }}" 
                            aria-controls="collapse-{{ loop.index }}">
                        <span>
                            <i class="bi bi-chevron-down collapse-icon"></i>
                            <span class="formatted-date" data-date="{{ date }}">{{ date }}</span>
                            <small class="text-muted ms-2">
                                ({{ invoices|length }} venta{{ 's' if invoices|length != 1 }})
                                <span class="ms-2">Total: {{ invoices|sum(attribute='total')|currency_co }}</span>
                                {% set efectivo = invoices|selectattr('payment_method', 'equalto', 'cash')|sum(attribute='total') %}
                                {% set transferencia = invoices|selectattr('payment_method', 'equalto', 'transfer')|sum(attribute='total') %}
                                {% if efectivo > 0 %}
                                <span class="ms-2 text-success">üíµ Efectivo: {{ efectivo|currency_co }}</span>
                                {% endif %}
                                {% if transferencia > 0 %}
                                <span class="ms-2 text-primary">üí≥ Transferencias: {{ transferencia|currency_co }}</span>
                                {% endif %}
                                {% set total_groomer = namespace(value=0) %}
                                {% for inv in invoices %}
                                    {% if inv.notes and ('Servicios de mascota' in inv.notes or 'Cita' in inv.notes) %}
                                        {% set total_groomer.value = total_groomer.value + (inv.subtotal / 2) %}
                                    {% endif %}
                                {% endfor %}
                                {% if total_groomer.value > 0 %}
                                <span class="ms-2" style="color: #8b5cf6;">üêæ Groomer: {{ total_groomer.value|currency_co }}</span>
                                {% endif %}
                            </small>
                        </span>
                    </button>
                </h5>
            </div>
            <div id="collapse-{{ loop.index }}" class="collapse{{ ' show' if loop.index == 1 }}">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Cliente</th>
                                <th>Hora</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in invoices %}
                            <tr>
                                <td>{{ invoice.number }}</td>
                                <td>{{ invoice.customer.name }}</td>
                                <td>
                                    <span class="utc-time" data-utc="{{ invoice.date.isoformat() }}">
                                        {{ invoice.date|format_time_co }}
                                    </span>
                                </td>
                                <td>{{ invoice.total | currency_co }}</td>
                                <td>
                                    <span
                                        class="badge bg-{{ 'success' if invoice.status in ['paid','validated'] else ('warning' if invoice.status == 'pending' else 'danger') }}">
                                        {{ {'paid': 'Pagada', 'pending': 'Pendiente', 'cancelled': 'Cancelada',
                                        'validated': 'Validada'}.get(invoice.status, invoice.status) }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('invoices.view', id=invoice.id) }}"
                                                class="btn btn-outline-primary" title="Ver">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% if current_user.role == 'admin' %}
                                            {% if invoice.status == 'pending' %}
                                            <form method="post" action="{{ url_for('invoices.validate', id=invoice.id) }}"
                                                onsubmit="return confirm('Validar esta venta?');">
                                                <button type="submit" class="btn btn-outline-success" title="Validar">
                                                    <i class="bi bi-check2-circle"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                            {% if invoice.status != 'validated' %}
                                            <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal"
                                                data-bs-target="#editModal" 
                                                data-id="{{ invoice.id }}"
                                                data-number="{{ invoice.number }}"
                                                data-payment-method="{{ invoice.payment_method }}"
                                                data-discount="{{ invoice.discount or 0 }}"
                                                data-subtotal="{{ invoice.subtotal }}"
                                                data-tax="{{ invoice.tax }}"
                                                data-total="{{ invoice.total }}"
                                                title="Editar">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deleteModal" data-id="{{ invoice.id }}"
                                                data-number="{{ invoice.number }}" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="d-flex gap-1">
                                            <span class="fs-5" title="{{ 'Efectivo' if invoice.payment_method == 'cash' else ('Transferencia' if invoice.payment_method == 'transfer' else 'Efectivo') }}">
                                                {% if invoice.payment_method == 'cash' %}
                                                    üíµ
                                                {% elif invoice.payment_method == 'transfer' %}
                                                    üí≥
                                                {% else %}
                                                    üíµ
                                                {% endif %}
                                            </span>
                                            {% if invoice.notes and ('Servicios de mascota' in invoice.notes or 'Cita' in invoice.notes) %}
                                            <span class="fs-5" style="color: #8b5cf6;" title="Groomer: {{ (invoice.subtotal / 2)|currency_co }} (50% del subtotal)">
                                                üêæ
                                            </span>
                                            {% endif %}
                                            {% if invoice.discount and invoice.discount > 0 %}
                                            <span class="fs-5" title="Descuento aplicado: {{ invoice.discount|currency_co }}">
                                                üè∑Ô∏è
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-info">
            {% if query %}
            No se encontraron ventas para "{{ query }}".
            {% else %}
            No hay ventas registradas. <a href="{{ url_for('invoices.new') }}">Crear la primera</a>.
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para editar factura -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="bi bi-pencil-square"></i> Editar Venta <strong id="editInvoiceNumber"></strong>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editForm" action="" method="post">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Los cambios quedar√°n registrados en las notas de la factura.
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_payment_method" class="form-label">
                            <strong>M√©todo de Pago:</strong> <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="edit_payment_method" name="payment_method" required>
                            <option value="cash">Efectivo</option>
                            <option value="transfer">Transferencia</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="edit_discount" class="form-label">
                            <strong>Ajuste de Valor (Descuento o Incremento):</strong>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="edit_discount" name="discount" 
                                   step="100" value="0"
                                   oninput="updateEditTotal()">
                        </div>
                        <div class="form-text">
                            Valor negativo = descuento, Valor positivo = incremento (opcional)
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_reason" class="form-label">
                            <strong>Raz√≥n del Cambio:</strong> <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="edit_reason" name="reason" rows="3" required
                                  placeholder="Ej: Cliente cambi√≥ forma de pago, descuento por fidelidad, etc."></textarea>
                        <div class="form-text">
                            Explica por qu√© se est√° realizando este cambio
                        </div>
                    </div>

                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Resumen de la Venta:</h6>
                            <ul class="mb-0">
                                <li><strong>Subtotal:</strong> <span id="edit-subtotal-display">$0</span></li>
                                <li><strong>IVA:</strong> <span id="edit-tax-display">$0</span></li>
                                <li><strong>Ajuste:</strong> <span id="edit-discount-display">$0</span></li>
                                <li class="border-top pt-2 mt-2"><strong>Total a Pagar:</strong> <span id="edit-total-display" class="fs-5 text-success">$0</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que deseas eliminar la venta <strong id="invoiceNumber"></strong>?</p>
                <p>Esta acci√≥n devolver√° los productos al inventario.</p>
                <p class="text-danger">Esta acci√≥n no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" action="" method="post">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Manejar la rotaci√≥n del icono chevron
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
            const targetId = button.getAttribute('data-bs-target');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                targetElement.addEventListener('show.bs.collapse', () => {
                    button.classList.remove('collapsed');
                });
                
                targetElement.addEventListener('hide.bs.collapse', () => {
                    button.classList.add('collapsed');
                });
            }
        });
        
        // Formatear fechas agrupadas
        document.querySelectorAll('.formatted-date').forEach(el => {
            const date = el.getAttribute('data-date');
            if (!date) return;
            
            // Parsear la fecha como local (YYYY-MM-DD) sin conversi√≥n de zona horaria
            const [year, month, day] = date.split('-').map(Number);
            const d = new Date(year, month - 1, day);
            
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            el.textContent = d.toLocaleDateString('es-ES', options);
        });

        // Formatear horas en zona horaria local
        document.querySelectorAll('.utc-time').forEach(el => {
            const iso = el.getAttribute('data-utc');
            if (!iso) return;

            // Convertir la hora UTC a hora de Colombia (UTC-5)
            // No necesitamos convertir la hora aqu√≠ ya que la conversi√≥n se hace en el servidor
            // y el elemento ya tiene la hora correcta de Colombia
            return;
        });
    });
    // Set up delete modal
    document.addEventListener('DOMContentLoaded', function () {
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button.dataset.id;
            const number = button.dataset.number;
            document.getElementById('invoiceNumber').textContent = number;
            document.getElementById('deleteForm').action = "{{ url_for('invoices.delete', id=0) }}".replace('0', id);
        });

        // Set up edit modal
        const editModal = document.getElementById('editModal');
        let editSubtotal = 0;
        let editTax = 0;
        
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button.dataset.id;
            const number = button.dataset.number;
            const paymentMethod = button.dataset.paymentMethod;
            const discount = parseFloat(button.dataset.discount) || 0;
            const subtotal = parseFloat(button.dataset.subtotal) || 0;
            const tax = parseFloat(button.dataset.tax) || 0;
            const total = parseFloat(button.dataset.total) || 0;
            
            // Store values for calculation
            editSubtotal = subtotal;
            editTax = tax;
            
            // Set form values
            document.getElementById('editInvoiceNumber').textContent = number;
            document.getElementById('edit_payment_method').value = paymentMethod;
            document.getElementById('edit_discount').value = discount;
            document.getElementById('edit_reason').value = '';
            
            // Update displays
            document.getElementById('edit-subtotal-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(subtotal);
            document.getElementById('edit-tax-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(tax);
            document.getElementById('edit-discount-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(discount);
            document.getElementById('edit-total-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(total);
            
            // Set form action
            document.getElementById('editForm').action = "{{ url_for('invoices.edit', id=0) }}".replace('0', id);
        });
        
        // Update edit total function
        window.updateEditTotal = function() {
            const discountInput = document.getElementById('edit_discount');
            const discount = parseFloat(discountInput.value) || 0;
            
            // Calcular el total final (permite valores negativos y positivos)
            const finalTotal = editSubtotal + editTax - discount;
            
            // Update displays
            document.getElementById('edit-discount-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(discount);
            
            document.getElementById('edit-total-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(finalTotal);
        };
    });
</script>
{% endblock %}