{% extends 'layout.html' %}

{% block title %}Ventas ({{ setting.document_label }}s) - Green-POS{% endblock %}

{% block page_title %}Ventas ({{ setting.document_label }}s){% endblock %}

{% block page_actions %}
<a href="{{ url_for('invoices.new') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> Nueva Venta
</a>
{% endblock %}

{% block extra_css %}
<style>
    .card-header .btn-link {
        transition: all 0.3s ease;
    }
    .card-header .btn-link:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    .collapse-icon {
        transition: transform 0.3s ease;
        display: inline-block;
    }
    .collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <form action="{{ url_for('invoices.list') }}" method="get">
            <div class="input-group">
                <input type="text" name="query" class="form-control"
                    placeholder="Buscar por n√∫mero, cliente o documento..." value="{{ query }}">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i> Buscar
                </button>
                {% if query %}
                <a href="{{ url_for('invoices.list') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Limpiar
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if invoices_by_date %}
        {% for date, invoices in invoices_by_date.items() %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <button class="btn btn-link text-decoration-none text-dark w-100 text-start d-flex justify-content-between align-items-center p-0{{ ' collapsed' if loop.index != 1 }}" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapse-{{ loop.index }}" 
                            aria-expanded="{{ 'true' if loop.index == 1 else 'false' }}" 
                            aria-controls="collapse-{{ loop.index }}">
                        <span>
                            <i class="bi bi-chevron-down collapse-icon"></i>
                            <span class="formatted-date" data-date="{{ date }}">{{ date }}</span>
                            <small class="text-muted ms-2">
                                ({{ invoices|length }} venta{{ 's' if invoices|length != 1 }})
                                {% set total_ventas = namespace(value=0) %}
                                {% for inv in invoices %}
                                    {% if inv.is_credit_note() %}
                                        {% set total_ventas.value = total_ventas.value - inv.total %}
                                    {% else %}
                                        {% set total_ventas.value = total_ventas.value + inv.total %}
                                    {% endif %}
                                {% endfor %}
                                <span class="ms-2">Total: {{ total_ventas.value|currency_co }}</span>
                                
                                {# Calcular efectivo: suma directa + parte mixta (SOLO dinero f√≠sico recibido) #}
                                {% set efectivo = namespace(value=0) %}
                                {% for inv in invoices %}
                                    {# NO sumar si es NC (document_type='credit_note') #}
                                    {% if not inv.is_credit_note() %}
                                        {# NO sumar si fue pagada totalmente con NC (payment_method='credit_note') #}
                                        {% if inv.payment_method == 'cash' %}
                                            {% set efectivo.value = efectivo.value + inv.total %}
                                        {% elif inv.payment_method == 'mixed' and inv.notes and 'Efectivo: $' in inv.notes %}
                                            {% set cash_part = inv.notes.split('Efectivo: $')[1].split('\n')[0].replace(',', '').replace('.', '') %}
                                            {% set efectivo.value = efectivo.value + (cash_part|int) %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                
                                {# Calcular transferencia: suma directa + parte mixta (SOLO dinero bancario recibido) #}
                                {% set transferencia = namespace(value=0) %}
                                {% for inv in invoices %}
                                    {# NO sumar si es NC (document_type='credit_note') #}
                                    {% if not inv.is_credit_note() %}
                                        {# NO sumar si fue pagada totalmente con NC (payment_method='credit_note') #}
                                        {% if inv.payment_method == 'transfer' %}
                                            {% set transferencia.value = transferencia.value + inv.total %}
                                        {% elif inv.payment_method == 'mixed' and inv.notes and 'Transferencia: $' in inv.notes %}
                                            {% set transfer_part = inv.notes.split('Transferencia: $')[1].split('\n')[0].replace(',', '').replace('.', '') %}
                                            {% set transferencia.value = transferencia.value + (transfer_part|int) %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% if efectivo.value > 0 %}
                                <span class="ms-2 text-success">üíµ Efectivo: {{ efectivo.value|currency_co }}</span>
                                {% endif %}
                                {% if transferencia.value > 0 %}
                                <span class="ms-2 text-primary">üí≥ Transferencias: {{ transferencia.value|currency_co }}</span>
                                {% endif %}
                                {% set total_groomer = namespace(value=0) %}
                                {% for inv in invoices %}
                                    {% if inv.notes and ('Servicios de mascota' in inv.notes or 'Cita' in inv.notes) %}
                                        {% set total_groomer.value = total_groomer.value + (inv.subtotal / 2) %}
                                    {% endif %}
                                {% endfor %}
                                {% if total_groomer.value > 0 %}
                                <span class="ms-2" style="color: #8b5cf6;">üêæ Groomer: {{ total_groomer.value|currency_co }}</span>
                                {% endif %}
                            </small>
                        </span>
                    </button>
                </h5>
            </div>
            <div id="collapse-{{ loop.index }}" class="collapse{{ ' show' if loop.index == 1 }}">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>N√∫mero</th>
                                <th>Cliente</th>
                                <th>Hora</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in invoices %}
                            <tr>
                                <td>
                                    {% if invoice.is_credit_note() %}
                                    <span class="badge bg-danger" title="Nota de Cr√©dito">NC</span>
                                    {% else %}
                                    <span class="badge bg-primary" title="Factura">F</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ invoice.number }}
                                    {% if invoice.is_credit_note() and invoice.reference_invoice %}
                                    <br><small class="text-muted">Ref: {{ invoice.reference_invoice.number }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ invoice.customer.name }}</td>
                                <td>
                                    <span class="utc-time" data-utc="{{ invoice.date.isoformat() }}">
                                        {{ invoice.date|format_time_co }}
                                    </span>
                                </td>
                                <td>
                                    {% if invoice.is_credit_note() %}
                                    <span class="text-danger">-{{ invoice.total | currency_co }}</span>
                                    {% else %}
                                    {{ invoice.total | currency_co }}
                                    {% endif %}
                                </td>
                                <td>
                                    <span id="status-badge-{{ invoice.id }}"
                                        class="badge bg-{{ 'success' if invoice.status in ['paid','validated'] else ('warning' if invoice.status == 'pending' else 'danger') }}">
                                        {{ {'paid': 'Pagada', 'pending': 'Pendiente', 'cancelled': 'Cancelada',
                                        'validated': 'Validada'}.get(invoice.status, invoice.status) }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div id="action-buttons-{{ invoice.id }}" class="btn-group btn-group-sm">
                                            <a href="{{ url_for('invoices.view', id=invoice.id) }}"
                                                class="btn btn-outline-primary" title="Ver">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% if current_user.role == 'admin' and invoice.status == 'pending' %}
                                            <button type="button" 
                                                    class="btn btn-outline-success btn-sm" 
                                                    title="Validar"
                                                    onclick="openValidateModal({{ invoice.id }}, '{{ invoice.number }}')">
                                                <i class="bi bi-check2-circle"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal"
                                                data-bs-target="#editModal" 
                                                data-id="{{ invoice.id }}"
                                                data-number="{{ invoice.number }}"
                                                data-payment-method="{{ invoice.payment_method }}"
                                                data-discount="{{ invoice.discount or 0 }}"
                                                data-subtotal="{{ invoice.subtotal }}"
                                                data-tax="{{ invoice.tax }}"
                                                data-total="{{ invoice.total }}"
                                                data-customer-id="{{ invoice.customer_id }}"
                                                data-notes="{{ invoice.notes or '' }}"
                                                title="Editar">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deleteModal" data-id="{{ invoice.id }}"
                                                data-number="{{ invoice.number }}" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex gap-1">
                                            {% if invoice.is_credit_note() %}
                                                {# Si es NC, mostrar icono de NC independiente del payment_method #}
                                                <span class="fs-5" title="Nota de Cr√©dito (Devoluci√≥n)">üé´</span>
                                            {% elif invoice.payment_method == 'cash' %}
                                                <span class="fs-5" title="Efectivo">üíµ</span>
                                            {% elif invoice.payment_method == 'transfer' %}
                                                <span class="fs-5" title="Transferencia">üí≥</span>
                                            {% elif invoice.payment_method == 'credit_note' %}
                                                <span class="fs-5" title="Pagado con Nota de Cr√©dito">üé´</span>
                                            {% elif invoice.payment_method == 'mixed' %}
                                                {% if invoice.notes and '--- PAGO MIXTO ---' in invoice.notes %}
                                                    {% set parts = [] %}
                                                    {% if 'Nota de Cr√©dito: $' in invoice.notes %}
                                                        {% set nc_line = invoice.notes.split('Nota de Cr√©dito: $')[1].split('\n')[0] %}
                                                        {% set parts = parts + [nc_line.replace(',', '.') + ' NC'] %}
                                                    {% endif %}
                                                    {% if 'Efectivo: $' in invoice.notes %}
                                                        {% set cash_line = invoice.notes.split('Efectivo: $')[1].split('\n')[0] %}
                                                        {% set parts = parts + [cash_line.replace(',', '.') + ' Efectivo'] %}
                                                    {% endif %}
                                                    {% if 'Transferencia: $' in invoice.notes %}
                                                        {% set transfer_line = invoice.notes.split('Transferencia: $')[1].split('\n')[0] %}
                                                        {% set parts = parts + [transfer_line.replace(',', '.') + ' Transferencia'] %}
                                                    {% endif %}
                                                    {% set payment_details = 'Mixto: ' + parts|join(', ') if parts else 'Pago combinado' %}
                                                {% else %}
                                                    {% set payment_details = 'Pago combinado' %}
                                                {% endif %}
                                                <span class="fs-5" title="{{ payment_details }}">üí∞</span>
                                            {% else %}
                                                <span class="fs-5" title="Efectivo">üíµ</span>
                                            {% endif %}
                                            {% if invoice.notes and ('Servicios de mascota' in invoice.notes or 'Cita' in invoice.notes) %}
                                            <span class="fs-5" style="color: #8b5cf6;" title="Groomer: {{ (invoice.subtotal / 2)|currency_co }} (50% del subtotal)">
                                                üêæ
                                            </span>
                                            {% endif %}
                                            {% if invoice.discount and invoice.discount > 0 %}
                                            <span class="fs-5" title="Descuento aplicado: {{ invoice.discount|currency_co }}">
                                                üè∑Ô∏è
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-info">
            {% if query %}
            No se encontraron ventas para "{{ query }}".
            {% else %}
            No hay ventas registradas. <a href="{{ url_for('invoices.new') }}">Crear la primera</a>.
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para editar factura -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="bi bi-pencil-square"></i> Editar Venta <strong id="editInvoiceNumber"></strong>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editForm" action="" method="post">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Los cambios quedar√°n registrados en las notas de la factura.
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_payment_method" class="form-label">
                            <strong>M√©todo de Pago:</strong> <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="edit_payment_method" name="payment_method" required>
                            <option value="cash">Efectivo</option>
                            <option value="transfer">Transferencia</option>
                            <option value="credit_note">Nota de Cr√©dito</option>
                            <option value="mixed">Mixto (Discriminado)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="edit_discount" class="form-label">
                            <strong>Ajuste de Valor (Descuento o Incremento):</strong>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="edit_discount" name="discount" 
                                   step="100" value="0"
                                   oninput="updateEditTotal()">
                        </div>
                        <div class="form-text">
                            Valor negativo = descuento, Valor positivo = incremento (opcional)
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit_reason" class="form-label">
                            <strong>Raz√≥n del Cambio:</strong> <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="edit_reason" name="reason" rows="3" required
                                  placeholder="Ej: Cliente cambi√≥ forma de pago, descuento por fidelidad, etc."></textarea>
                        <div class="form-text">
                            Explica por qu√© se est√° realizando este cambio
                        </div>
                    </div>

                    <!-- Secci√≥n de Saldo de NC Disponible -->
                    <div class="mb-3" id="edit_creditBalanceInfo" style="display: none;">
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i>
                            <strong>Saldo Disponible:</strong>
                            <span id="edit_creditBalanceAmount">$0</span>
                        </div>
                    </div>

                    <!-- Detalle de pago mixto (discriminado) -->
                    <div id="edit_mixedPaymentDetails" style="display: none;">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i>
                            <strong>Pago Mixto:</strong> Especifica el monto con cada m√©todo. La suma debe ser igual al total de la factura.
                        </div>
                        
                        <div class="mb-2">
                            <label for="edit_amount_credit_note" class="form-label">Nota de Cr√©dito ($)</label>
                            <input type="number" id="edit_amount_credit_note" name="amount_credit_note" 
                                   class="form-control edit-mixed-payment-input" min="0" step="0.01" value="0">
                            <small class="text-muted">Disponible: <span id="edit_available_nc">$0</span></small>
                        </div>
                        
                        <div class="mb-2">
                            <label for="edit_amount_cash" class="form-label">Efectivo ($)</label>
                            <input type="number" id="edit_amount_cash" name="amount_cash" 
                                   class="form-control edit-mixed-payment-input" min="0" step="0.01" value="0">
                        </div>
                        
                        <div class="mb-2">
                            <label for="edit_amount_transfer" class="form-label">Transferencia ($)</label>
                            <input type="number" id="edit_amount_transfer" name="amount_transfer" 
                                   class="form-control edit-mixed-payment-input" min="0" step="0.01" value="0">
                        </div>
                        
                        <div class="alert alert-secondary mt-2">
                            <strong>Total especificado:</strong> $<span id="edit_mixedPaymentTotal">0</span><br>
                            <strong>Total factura:</strong> $<span id="edit_mixedInvoiceTotal">0</span><br>
                            <span id="edit_mixedPaymentStatus" class="text-danger">‚ö† Los totales no coinciden</span>
                        </div>
                    </div>

                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Resumen de la Venta:</h6>
                            <ul class="mb-0">
                                <li><strong>Subtotal:</strong> <span id="edit-subtotal-display">$0</span></li>
                                <li><strong>IVA:</strong> <span id="edit-tax-display">$0</span></li>
                                <li><strong>Ajuste:</strong> <span id="edit-discount-display">$0</span></li>
                                <li class="border-top pt-2 mt-2"><strong>Total a Pagar:</strong> <span id="edit-total-display" class="fs-5 text-success">$0</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> 
                    <strong>¬°Atenci√≥n!</strong> Esta acci√≥n es permanente.
                </div>
                <p>¬øEst√°s seguro de que deseas eliminar la venta <strong id="invoiceNumber"></strong>?</p>
                <p><strong>Lo que suceder√°:</strong></p>
                <ul class="mb-0">
                    <li>‚úÖ Los productos vendidos volver√°n al inventario</li>
                    <li>‚úÖ Se registrar√° el movimiento en el historial de stock</li>
                    <li>‚úÖ El conteo de ventas del producto se actualizar√°</li>
                    <li>‚ùå Esta acci√≥n no se puede deshacer</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" action="" method="post">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Validaci√≥n -->
<div class="modal fade" id="validateModal" tabindex="-1" aria-labelledby="validateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="validateModalLabel">
                    <i class="bi bi-check2-circle"></i> Confirmar Validaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√° seguro de que desea validar la venta <strong id="validateInvoiceNumber"></strong>?</p>
                <p class="text-muted small">
                    <i class="bi bi-info-circle"></i> Una vez validada, la venta no podr√° ser editada ni eliminada.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" id="confirmValidateBtn">
                    <i class="bi bi-check2-circle"></i> Validar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Variable global para almacenar ID de factura a validar
    let invoiceToValidate = null;

    // Funci√≥n para abrir modal de validaci√≥n
    function openValidateModal(invoiceId, invoiceNumber) {
        invoiceToValidate = invoiceId;
        document.getElementById('validateInvoiceNumber').textContent = invoiceNumber;
        
        const modal = new bootstrap.Modal(document.getElementById('validateModal'));
        modal.show();
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Soporte para tecla Enter en el modal de validaci√≥n
        const validateModalElement = document.getElementById('validateModal');
        if (validateModalElement) {
            validateModalElement.addEventListener('shown.bs.modal', function() {
                // Focus en el bot√≥n confirmar
                document.getElementById('confirmValidateBtn').focus();
                
                // Agregar listener para Enter
                function handleEnterKey(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('confirmValidateBtn').click();
                    }
                }
                
                validateModalElement.addEventListener('keypress', handleEnterKey);
                
                // Limpiar listener cuando el modal se cierre
                validateModalElement.addEventListener('hidden.bs.modal', function cleanup() {
                    validateModalElement.removeEventListener('keypress', handleEnterKey);
                    validateModalElement.removeEventListener('hidden.bs.modal', cleanup);
                }, { once: true });
            });
        }
        
        // Handler para confirmar validaci√≥n
        document.getElementById('confirmValidateBtn').addEventListener('click', async function() {
            if (!invoiceToValidate) return;
            
            const btn = this;
            const originalText = btn.innerHTML;
            
            // Mostrar estado de carga
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Validando...';
            
            try {
                const response = await fetch(`/api/invoices/validate/${invoiceToValidate}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Actualizar badge de estado usando el ID √∫nico
                    const statusBadge = document.getElementById(`status-badge-${invoiceToValidate}`);
                    if (statusBadge) {
                        statusBadge.className = 'badge bg-success';
                        statusBadge.textContent = 'Validada';
                    }
                    
                    // Ocultar botones de acci√≥n usando el ID √∫nico del contenedor
                    const actionButtonsContainer = document.getElementById(`action-buttons-${invoiceToValidate}`);
                    if (actionButtonsContainer) {
                        actionButtonsContainer.style.display = 'none';
                    }
                    
                    // Mostrar flash message din√°mico
                    showFlashMessage('Venta validada exitosamente', 'success');
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('validateModal')).hide();
                } else {
                    showFlashMessage(data.message || 'Error al validar venta', 'danger');
                }
            } catch (error) {
                console.error('Error validating invoice:', error);
                showFlashMessage('Error de conexi√≥n al validar venta', 'danger');
            } finally {
                // Restaurar bot√≥n
                btn.disabled = false;
                btn.innerHTML = originalText;
                invoiceToValidate = null;
            }
        });
        
        // Manejar la rotaci√≥n del icono chevron
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
            const targetId = button.getAttribute('data-bs-target');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                targetElement.addEventListener('show.bs.collapse', () => {
                    button.classList.remove('collapsed');
                });
                
                targetElement.addEventListener('hide.bs.collapse', () => {
                    button.classList.add('collapsed');
                });
            }
        });
        
        // Formatear fechas agrupadas
        document.querySelectorAll('.formatted-date').forEach(el => {
            const date = el.getAttribute('data-date');
            if (!date) return;
            
            // Parsear la fecha como local (YYYY-MM-DD) sin conversi√≥n de zona horaria
            const [year, month, day] = date.split('-').map(Number);
            const d = new Date(year, month - 1, day);
            
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            el.textContent = d.toLocaleDateString('es-ES', options);
        });

        // Formatear horas en zona horaria local
        document.querySelectorAll('.utc-time').forEach(el => {
            const iso = el.getAttribute('data-utc');
            if (!iso) return;

            // Convertir la hora UTC a hora de Colombia (UTC-5)
            // No necesitamos convertir la hora aqu√≠ ya que la conversi√≥n se hace en el servidor
            // y el elemento ya tiene la hora correcta de Colombia
            return;
        });
    });
    // Set up delete modal
    document.addEventListener('DOMContentLoaded', function () {
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button.dataset.id;
            const number = button.dataset.number;
            document.getElementById('invoiceNumber').textContent = number;
            document.getElementById('deleteForm').action = "{{ url_for('invoices.delete', id=0) }}".replace('0', id);
        });

        // Set up edit modal
        const editModal = document.getElementById('editModal');
        let editSubtotal = 0;
        let editTax = 0;
        
        // Variables para pago mixto en edici√≥n
        let editCurrentCustomerCreditBalance = 0;  // Saldo disponible de NC del cliente
        let editCurrentInvoiceTotal = 0;           // Total de la factura (subtotal + IVA)
        let editCustomerId = null;                 // ID del cliente de la factura
        
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button.dataset.id;
            const number = button.dataset.number;
            const paymentMethod = button.dataset.paymentMethod;
            const discount = parseFloat(button.dataset.discount) || 0;
            const subtotal = parseFloat(button.dataset.subtotal) || 0;
            const tax = parseFloat(button.dataset.tax) || 0;
            const total = parseFloat(button.dataset.total) || 0;
            
            // Extraer customer_id y notes del bot√≥n
            const customerId = parseInt(button.dataset.customerId) || null;
            const notes = button.dataset.notes || '';
            
            // Store values for calculation
            editSubtotal = subtotal;
            editTax = tax;
            editCurrentInvoiceTotal = total;  // Total para validaci√≥n mixta
            editCustomerId = customerId;      // ID del cliente
            
            // Set form values
            document.getElementById('editInvoiceNumber').textContent = number;
            document.getElementById('edit_payment_method').value = paymentMethod;
            document.getElementById('edit_discount').value = discount;
            document.getElementById('edit_reason').value = '';
            
            // Resetear campos de pago mixto
            document.getElementById('edit_amount_credit_note').value = 0;
            document.getElementById('edit_amount_cash').value = 0;
            document.getElementById('edit_amount_transfer').value = 0;
            
            // Ocultar secciones de pago mixto por defecto
            document.getElementById('edit_mixedPaymentDetails').style.display = 'none';
            document.getElementById('edit_creditBalanceInfo').style.display = 'none';
            
            // Update displays
            document.getElementById('edit-subtotal-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(subtotal);
            document.getElementById('edit-tax-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(tax);
            document.getElementById('edit-discount-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(discount);
            document.getElementById('edit-total-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(total);
            
            // Set form action
            document.getElementById('editForm').action = "{{ url_for('invoices.edit', id=0) }}".replace('0', id);
            
            // Cargar saldo de NC del cliente
            if (customerId) {
                fetch(`/api/customers/${customerId}`)
                    .then(response => response.json())
                    .then(data => {
                        editCurrentCustomerCreditBalance = data.credit_balance || 0;
                        
                        // Actualizar displays
                        document.getElementById('edit_creditBalanceAmount').textContent = 
                            '$' + editCurrentCustomerCreditBalance.toLocaleString('es-CO');
                        document.getElementById('edit_available_nc').textContent = 
                            '$' + editCurrentCustomerCreditBalance.toLocaleString('es-CO');
                        
                        // Si m√©todo actual es mixto o NC, mostrar saldo
                        if (paymentMethod === 'credit_note' || paymentMethod === 'mixed') {
                            document.getElementById('edit_creditBalanceInfo').style.display = 'block';
                        }
                        
                        // Si m√©todo es mixto, parsear y poblar campos
                        if (paymentMethod === 'mixed') {
                            parseMixedPaymentFromNotes(notes);
                        }
                    })
                    .catch(error => {
                        console.error('Error cargando saldo de NC:', error);
                        editCurrentCustomerCreditBalance = 0;
                        document.getElementById('edit_creditBalanceAmount').textContent = '$0';
                        document.getElementById('edit_available_nc').textContent = '$0';
                    });
            }
        });
        
        // Update edit total function
        window.updateEditTotal = function() {
            const discountInput = document.getElementById('edit_discount');
            const discount = parseFloat(discountInput.value) || 0;
            
            // Calcular el total final (permite valores negativos y positivos)
            const finalTotal = editSubtotal + editTax - discount;
            
            // Update displays
            document.getElementById('edit-discount-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(discount);
            
            document.getElementById('edit-total-display').textContent = 
                new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(finalTotal);
            
            // Actualizar tambi√©n el total para validaci√≥n de pago mixto
            editCurrentInvoiceTotal = finalTotal;
        };
        
        // Funci√≥n para calcular y validar total de pago mixto en edici√≥n
        function validateEditMixedPayment() {
            const ncAmount = parseFloat(document.getElementById('edit_amount_credit_note').value) || 0;
            const cashAmount = parseFloat(document.getElementById('edit_amount_cash').value) || 0;
            const transferAmount = parseFloat(document.getElementById('edit_amount_transfer').value) || 0;
            
            const totalSpecified = ncAmount + cashAmount + transferAmount;
            const invoiceTotal = editCurrentInvoiceTotal;
            
            // Formateo de moneda colombiana
            const formatCo = (n) => {
                n = Math.round(Number(n) || 0);
                return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            };
            
            // Actualizar displays visuales
            document.getElementById('edit_mixedPaymentTotal').textContent = formatCo(totalSpecified);
            document.getElementById('edit_mixedInvoiceTotal').textContent = formatCo(invoiceTotal);
            
            const statusElement = document.getElementById('edit_mixedPaymentStatus');
            
            // Validaci√≥n 1: NC no debe exceder saldo disponible
            if (ncAmount > editCurrentCustomerCreditBalance) {
                statusElement.innerHTML = '<i class="bi bi-x-circle"></i> NC excede saldo disponible';
                statusElement.className = 'text-danger';
                return false;
            }
            
            // Validaci√≥n 2: Totales deben coincidir (tolerancia 0.01 para floats)
            if (Math.abs(totalSpecified - invoiceTotal) < 0.01) {
                statusElement.innerHTML = '<i class="bi bi-check-circle"></i> Totales coinciden';
                statusElement.className = 'text-success';
                return true;
            } else if (totalSpecified > invoiceTotal) {
                statusElement.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Total especificado excede factura';
                statusElement.className = 'text-warning';
                return false;
            } else {
                statusElement.innerHTML = '<i class="bi bi-x-circle"></i> Total especificado es menor que factura';
                statusElement.className = 'text-danger';
                return false;
            }
        }
        
        // Funci√≥n para parsear montos mixtos desde invoice.notes
        function parseMixedPaymentFromNotes(notes) {
            if (!notes) {
                return;
            }
            
            // Regex para extraer montos con formato colombiano ($123.456 o $123456)
            const ncMatch = notes.match(/Nota de Cr√©dito:\s*\$\s*([0-9.,]+)/i);
            const cashMatch = notes.match(/Efectivo:\s*\$\s*([0-9.,]+)/i);
            const transferMatch = notes.match(/Transferencia:\s*\$\s*([0-9.,]+)/i);
            
            // Funci√≥n helper para limpiar formato
            const cleanAmount = (match) => {
                if (!match) return 0;
                // Remover puntos de miles, convertir a float
                return parseFloat(match[1].replace(/\./g, '').replace(',', '.')) || 0;
            };
            
            // Poblar campos si se encontraron valores
            const ncAmount = cleanAmount(ncMatch);
            const cashAmount = cleanAmount(cashMatch);
            const transferAmount = cleanAmount(transferMatch);
            
            document.getElementById('edit_amount_credit_note').value = ncAmount;
            document.getElementById('edit_amount_cash').value = cashAmount;
            document.getElementById('edit_amount_transfer').value = transferAmount;
            
            // Mostrar secci√≥n de pago mixto
            document.getElementById('edit_mixedPaymentDetails').style.display = 'block';
            
            // Ejecutar validaci√≥n
            validateEditMixedPayment();
        }
        
        // Validaci√≥n en submit del formulario de edici√≥n
        const editForm = document.getElementById('editForm');
        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                const paymentMethod = document.getElementById('edit_payment_method').value;
                
                // Validar pago mixto si est√° seleccionado
                if (paymentMethod === 'mixed') {
                    if (!validateEditMixedPayment()) {
                        e.preventDefault();
                        alert('El pago mixto no es v√°lido. Verifique los montos especificados.');
                        return false;
                    }
                }
            });
        }
        
        // Event listener para cambio de m√©todo de pago en edici√≥n
        const editPaymentMethod = document.getElementById('edit_payment_method');
        const editCreditBalanceInfo = document.getElementById('edit_creditBalanceInfo');
        const editMixedPaymentDetails = document.getElementById('edit_mixedPaymentDetails');
        
        if (editPaymentMethod) {
            editPaymentMethod.addEventListener('change', function() {
                const method = this.value;
                
                // Mostrar/ocultar secci√≥n de pago mixto
                if (method === 'mixed') {
                    editMixedPaymentDetails.style.display = 'block';
                    editCreditBalanceInfo.style.display = 'block';
                    
                    // Actualizar saldo disponible en el campo NC
                    document.getElementById('edit_available_nc').textContent = 
                        '$' + editCurrentCustomerCreditBalance.toLocaleString('es-CO');
                    
                    // Ejecutar validaci√≥n inicial
                    validateEditMixedPayment();
                } else {
                    editMixedPaymentDetails.style.display = 'none';
                    
                    // Si m√©todo es NC puro, mostrar solo saldo
                    if (method === 'credit_note') {
                        editCreditBalanceInfo.style.display = 'block';
                    } else {
                        editCreditBalanceInfo.style.display = 'none';
                    }
                }
            });
        }
        
        // Event listeners para inputs de pago mixto (validaci√≥n en tiempo real)
        const editMixedPaymentInputs = document.querySelectorAll('.edit-mixed-payment-input');
        editMixedPaymentInputs.forEach(input => {
            input.addEventListener('input', validateEditMixedPayment);
        });
    });
    
    // Funci√≥n para mostrar flash message din√°mico
    function showFlashMessage(message, category) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${category} alert-dismissible alert-dismissible-auto fade show d-print-none`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insertar al inicio del contenido principal
        const container = document.querySelector('.container-fluid');
        if (container && container.firstChild) {
            container.insertBefore(alertDiv, container.firstChild);
        }
        
        // Auto-dismiss despu√©s de 5 segundos
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alertDiv);
            bsAlert.close();
        }, 5000);
    }
</script>
{% endblock %}