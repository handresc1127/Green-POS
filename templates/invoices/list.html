{% extends 'layout.html' %}

{% block title %}Ventas ({{ setting.document_label }}s) - Green-POS{% endblock %}

{% block page_title %}Ventas ({{ setting.document_label }}s){% endblock %}

{% block page_actions %}
<a href="{{ url_for('invoice_new') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> Nueva Venta
</a>
{% endblock %}

{% block extra_css %}
<style>
    .card-header .btn-link {
        transition: all 0.3s ease;
    }
    .card-header .btn-link:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    .collapse-icon {
        transition: transform 0.3s ease;
        display: inline-block;
    }
    .collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <form action="{{ url_for('invoice_list') }}" method="get">
            <div class="input-group">
                <input type="text" name="query" class="form-control"
                    placeholder="Buscar por n√∫mero, cliente o documento..." value="{{ query }}">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i> Buscar
                </button>
                {% if query %}
                <a href="{{ url_for('invoice_list') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> Limpiar
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if invoices_by_date %}
        {% for date, invoices in invoices_by_date.items() %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <button class="btn btn-link text-decoration-none text-dark w-100 text-start d-flex justify-content-between align-items-center p-0{{ ' collapsed' if loop.index != 1 }}" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapse-{{ loop.index }}" 
                            aria-expanded="{{ 'true' if loop.index == 1 else 'false' }}" 
                            aria-controls="collapse-{{ loop.index }}">
                        <span>
                            <i class="bi bi-chevron-down collapse-icon"></i>
                            <span class="formatted-date" data-date="{{ date }}">{{ date }}</span>
                            <small class="text-muted ms-2">
                                ({{ invoices|length }} venta{{ 's' if invoices|length != 1 }})
                                <span class="ms-2">Total: {{ invoices|sum(attribute='total')|currency_co }}</span>
                                {% set efectivo = invoices|selectattr('payment_method', 'equalto', 'cash')|sum(attribute='total') %}
                                {% set transferencia = invoices|selectattr('payment_method', 'equalto', 'transfer')|sum(attribute='total') %}
                                {% if efectivo > 0 %}
                                <span class="ms-2 text-success">üíµ Efectivo: {{ efectivo|currency_co }}</span>
                                {% endif %}
                                {% if transferencia > 0 %}
                                <span class="ms-2 text-primary">üí≥ Transferencias: {{ transferencia|currency_co }}</span>
                                {% endif %}
                            </small>
                        </span>
                    </button>
                </h5>
            </div>
            <div id="collapse-{{ loop.index }}" class="collapse{{ ' show' if loop.index == 1 }}">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>N√∫mero</th>
                                <th>Cliente</th>
                                <th>Hora</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for invoice in invoices %}
                            <tr>
                                <td>{{ invoice.number }}</td>
                                <td>{{ invoice.customer.name }}</td>
                                <td>
                                    <span class="utc-time" data-utc="{{ invoice.date.isoformat() }}">
                                        {{ invoice.date|format_time_co }}
                                    </span>
                                </td>
                                <td>{{ invoice.total | currency_co }}</td>
                                <td>
                                    <span
                                        class="badge bg-{{ 'success' if invoice.status in ['paid','validated'] else ('warning' if invoice.status == 'pending' else 'danger') }}">
                                        {{ {'paid': 'Pagada', 'pending': 'Pendiente', 'cancelled': 'Cancelada',
                                        'validated': 'Validada'}.get(invoice.status, invoice.status) }}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('invoice_view', id=invoice.id) }}"
                                                class="btn btn-outline-primary" title="Ver">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            {% if current_user.role == 'admin' %}
                                            {% if invoice.status == 'pending' %}
                                            <form method="post" action="{{ url_for('invoice_validate', id=invoice.id) }}"
                                                onsubmit="return confirm('Validar esta venta?');">
                                                <button type="submit" class="btn btn-outline-success" title="Validar">
                                                    <i class="bi bi-check2-circle"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                            {% if invoice.status != 'validated' %}
                                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                                                data-bs-target="#deleteModal" data-id="{{ invoice.id }}"
                                                data-number="{{ invoice.number }}" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            {% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="d-flex gap-1">
                                            <span class="fs-5" title="{{ 'Efectivo' if invoice.payment_method == 'cash' else ('Transferencia' if invoice.payment_method == 'transfer' else ('Tarjeta' if invoice.payment_method == 'card' else 'Mixto')) }}">
                                                {% if invoice.payment_method == 'cash' %}
                                                    üíµ
                                                {% elif invoice.payment_method == 'transfer' %}
                                                    üí≥
                                                {% elif invoice.payment_method == 'card' %}
                                                    üí≥
                                                {% elif invoice.payment_method == 'mixed' %}
                                                    üíµüí≥
                                                {% else %}
                                                    üíµ
                                                {% endif %}
                                            </span>
                                            {% if invoice.notes and ('Servicios de mascota' in invoice.notes or 'Cita' in invoice.notes) %}
                                            <span class="fs-5" title="Incluye servicios de mascota">
                                                üêæ
                                            </span>
                                            {% endif %}
                                            {% if invoice.discount and invoice.discount > 0 %}
                                            <span class="fs-5" title="Descuento aplicado: {{ invoice.discount|currency_co }}">
                                                üè∑Ô∏è
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-info">
            {% if query %}
            No se encontraron ventas para "{{ query }}".
            {% else %}
            No hay ventas registradas. <a href="{{ url_for('invoice_new') }}">Crear la primera</a>.
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que deseas eliminar la venta <strong id="invoiceNumber"></strong>?</p>
                <p>Esta acci√≥n devolver√° los productos al inventario.</p>
                <p class="text-danger">Esta acci√≥n no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="deleteForm" action="" method="post">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Manejar la rotaci√≥n del icono chevron
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
            const targetId = button.getAttribute('data-bs-target');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                targetElement.addEventListener('show.bs.collapse', () => {
                    button.classList.remove('collapsed');
                });
                
                targetElement.addEventListener('hide.bs.collapse', () => {
                    button.classList.add('collapsed');
                });
            }
        });
        
        // Formatear fechas agrupadas
        document.querySelectorAll('.formatted-date').forEach(el => {
            const date = el.getAttribute('data-date');
            if (!date) return;
            
            // Parsear la fecha como local (YYYY-MM-DD) sin conversi√≥n de zona horaria
            const [year, month, day] = date.split('-').map(Number);
            const d = new Date(year, month - 1, day);
            
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            el.textContent = d.toLocaleDateString('es-ES', options);
        });

        // Formatear horas en zona horaria local
        document.querySelectorAll('.utc-time').forEach(el => {
            const iso = el.getAttribute('data-utc');
            if (!iso) return;

            // Convertir la hora UTC a hora de Colombia (UTC-5)
            // No necesitamos convertir la hora aqu√≠ ya que la conversi√≥n se hace en el servidor
            // y el elemento ya tiene la hora correcta de Colombia
            return;
        });
    });
    // Set up delete modal
    document.addEventListener('DOMContentLoaded', function () {
        const deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button.dataset.id;
            const number = button.dataset.number;
            document.getElementById('invoiceNumber').textContent = number;
            document.getElementById('deleteForm').action = "{{ url_for('invoice_delete', id=0) }}".replace('0', id);
        });
    });
</script>
{% endblock %}