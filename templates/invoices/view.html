{% extends 'layout.html' %}

{% block title %}Venta {{ invoice.number }} - {{ setting.business_name or 'Venta' }}{% endblock %}

{% block page_title %}Venta #{{ invoice.number }} ({{ setting.document_label }}){% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button class="btn btn-outline-primary" onclick="window.print()">
        <i class="bi bi-printer"></i> Imprimir
    </button>
    <a href="{{ url_for('invoice_list') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h4 class="mb-3">{{ setting.business_name or 'Nombre de la Empresa' }}</h4>
                {% if setting.nit %}<p class="mb-1">NIT: {{ setting.nit }}</p>{% endif %}
                {% if setting.address %}<p class="mb-1">Dirección: {{ setting.address }}</p>{% endif %}
                {% if setting.phone %}<p class="mb-1">Teléfono: {{ setting.phone }}</p>{% endif %}
                {% if setting.email %}<p class="mb-1">Email: {{ setting.email }}</p>{% endif %}
                <p class="mb-1">Regimen IVA: {{ 'Responsable' if setting.iva_responsable else 'No responsable' }}</p>
            </div>
            <div class="col-md-6 text-md-end">
                <h4 class="mb-3">{{ setting.document_label }} #{{ invoice.number }}</h4>
                <p class="mb-1"><strong>Fecha:</strong> <span class="utc-datetime" data-utc="{{ invoice.date.isoformat() }}">{{ invoice.date.isoformat() }}</span></p>
                <p class="mb-1"><strong>Vendedor:</strong> {{ invoice.user.username if invoice.user else 'N/D' }}</p>
                <p class="mb-1">
                    <strong>Estado:</strong> 
                    <span class="badge bg-{{ 'success' if invoice.status in ['paid','validated'] else ('warning' if invoice.status == 'pending' else 'danger') }}">
                        {{ {'paid': 'Pagada', 'pending': 'Pendiente', 'cancelled': 'Cancelada', 'validated': 'Validada'}.get(invoice.status, invoice.status) }}
                    </span>
                </p>
                <p class="mb-1">
                    <strong>Método de Pago:</strong> 
                    {{ {'cash': 'Efectivo', 'credit_card': 'Tarjeta de Crédito', 'debit_card': 'Tarjeta de Débito', 'transfer': 'Transferencia Bancaria'}.get(invoice.payment_method, invoice.payment_method) }}
                </p>
            </div>
        </div>
        
        <hr>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h5 class="mb-2">Cliente</h5>
                <p class="mb-1"><strong>{{ invoice.customer.name }}</strong></p>
                <p class="mb-1">{{ invoice.customer.document }}</p>
                {% if invoice.customer.phone %}
                    <p class="mb-1">{{ invoice.customer.phone }}</p>
                {% endif %}
                {% if invoice.customer.email %}
                    <p class="mb-1">{{ invoice.customer.email }}</p>
                {% endif %}
                {% if invoice.customer.address %}
                    <p class="mb-1">{{ invoice.customer.address }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Producto</th>
                        <th class="text-center">Cantidad</th>
                        <th class="text-end">Precio Unitario</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.items %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ item.product.name }}</td>
                            <td class="text-center">{{ item.quantity }}</td>
                            <td class="text-end">${{ "%.2f"|format(item.price) }}</td>
                            <td class="text-end">${{ "%.2f"|format(item.quantity * item.price) }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                        <td class="text-end">${{ "%.2f"|format(invoice.subtotal) }}</td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end"><strong>IVA {% if setting.iva_responsable %}({{ (setting.tax_rate * 100)|round(2) }}%){% else %}(0%) - No responsable{% endif %}:</strong></td>
                        <td class="text-end">${{ "%.2f"|format(invoice.tax) }}</td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end"><strong>Total:</strong></td>
                        <td class="text-end"><strong>${{ "%.2f"|format(invoice.total) }}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        {% if invoice.notes %}
            <div class="mt-4">
                <h5>Notas</h5>
                <p>{{ invoice.notes }}</p>
            </div>
        {% endif %}
        
        <div class="mt-4 text-center">
            <p>¡Gracias por su compra!</p>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la venta #{{ invoice.number }}?</p>
                <p>Esta acción devolverá los productos al inventario.</p>
                <p class="text-danger">Esta acción no se deshace.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{{ url_for('invoice_delete', id=invoice.id) }}" method="post">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.utc-datetime').forEach(el => {
      const iso = el.getAttribute('data-utc');
      if(!iso) return;
      const d = new Date(iso + (iso.endsWith('Z') ? '' : 'Z'));
      const opts = { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' };
      el.textContent = d.toLocaleString(undefined, opts);
    });
  });
</script>
{% endblock %}
