{% extends 'layout.html' %}

{% block title %}Venta {{ invoice.number }} - {{ setting.business_name or 'Venta' }}{% endblock %}

{% block page_title %}<span class="d-print-none">Venta #{{ invoice.number }} ({{ setting.document_label }})</span>{% endblock %}

{% block page_info %}
<div class="d-print-none mb-3">
  <span class="badge bg-{{ 'success' if invoice.status in ['paid','validated'] else ('warning' if invoice.status == 'pending' else 'danger') }}">
    Estado: {{ {'paid': 'Pagada', 'pending': 'Pendiente', 'cancelled': 'Cancelada', 'validated': 'Validada'}.get(invoice.status, invoice.status) }}
  </span>
</div>
{% endblock %}

{% block page_actions %}
<div class="btn-group d-print-none">
    <button class="btn btn-outline-primary" onclick="window.print()">
        <i class="bi bi-printer"></i> Imprimir
    </button>
    <a href="{{ url_for('invoice_list') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>
{% endblock %}

{% block content %}
{# --- Watermark styles dinámicos sólo si hay logo --- #}
{% if setting.logo_path %}
<style>
  .invoice-watermark-wrapper { position: relative; }
  .invoice-watermark { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:0; }
    /* Forzar blanco y negro (alto contraste) */
    .invoice-watermark img { width:200px; height:200px; filter:grayscale(100%) contrast(190%) brightness(105%); object-fit:contain; }
  .invoice-content-layer { position:relative; z-index:1; }
    @media print { .invoice-watermark img { filter:grayscale(100%) contrast(190%) brightness(105%); } }
</style>
{% endif %}
<div class="card mb-4">
    <div class="card-body">
        <div class="invoice-watermark-wrapper mb-3">
            {% if setting.logo_path %}
            <div class="invoice-watermark">
                <img src="{{ url_for('static', filename=setting.logo_path) }}" alt="Logo">
            </div>
            {% endif %}
            <div class="invoice-content-layer">
                <div class="row">
                    <div class="col-6 col-md-6">
                        <h4 class="mb-3">{{ setting.business_name or 'Nombre de la Empresa' }}</h4>
                        {% if setting.nit %}<p class="mb-1">NIT: {{ setting.nit }}</p>{% endif %}
                        {% if setting.address %}<p class="mb-1">Dirección: {{ setting.address }}</p>{% endif %}
                        {% if setting.phone %}<p class="mb-1">Teléfono: {{ setting.phone }}</p>{% endif %}
                        {% if setting.email %}<p class="mb-1">Email: {{ setting.email }}</p>{% endif %}
                        <p class="mb-1">Regimen IVA: {{ 'Responsable' if setting.iva_responsable else 'No responsable' }}</p>
                    </div>
                    <div class="col-6 col-md-6 text-end">
                        <h4 class="mb-3">{{ setting.document_label }} #{{ invoice.number }}</h4>
                        <p class="mb-1"><strong>Fecha:</strong> <span class="utc-datetime" data-utc="{{ invoice.date.isoformat() }}">{{ invoice.date.isoformat() }}</span></p>
                        <p class="mb-1"><strong>Vendedor:</strong> {{ invoice.user.username if invoice.user else 'N/D' }}</p>
                        <p class="mb-1">
                            <strong>Método de Pago:</strong> 
                            {{ {'cash': 'Efectivo', 'credit_card': 'Tarjeta de Crédito', 'debit_card': 'Tarjeta de Débito', 'transfer': 'Transferencia Bancaria'}.get(invoice.payment_method, invoice.payment_method) }}
                        </p>
                    </div>
                </div>
            </div> {# invoice-content-layer #}
        </div> {# watermark-wrapper #}
        <hr>
        <div class="row mb-4">
                <div class="col-md-6">
                    <h5 class="mb-2">Cliente</h5>
                    <p class="mb-1"><strong>{{ invoice.customer.name }}</strong></p>
                    <p class="mb-1">{{ invoice.customer.document }}</p>
                    {% if invoice.customer.phone %}
                        <p class="mb-1">{{ invoice.customer.phone }}</p>
                    {% endif %}
                    {% if invoice.customer.email %}
                        <p class="mb-1">{{ invoice.customer.email }}</p>
                    {% endif %}
                    {% if invoice.customer.address %}
                        <p class="mb-1">{{ invoice.customer.address }}</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Producto</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Precio Unitario</th>
                            <th class="text-end">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in invoice.items %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ item.product.name }}</td>
                                <td class="text-center">{{ item.quantity }}</td>
                                <td class="text-end">${{ "%.2f"|format(item.price) }}</td>
                                <td class="text-end">${{ "%.2f"|format(item.quantity * item.price) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        {% if setting.iva_responsable %}
                        <tr>
                            <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                            <td class="text-end">${{ "%.2f"|format(invoice.subtotal) }}</td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-end"><strong>IVA ({{ (setting.tax_rate * 100)|round(2) }}%):</strong></td>
                            <td class="text-end">${{ "%.2f"|format(invoice.tax) }}</td>
                        </tr>
                         {% endif %}
                        <tr>
                            <td colspan="4" class="text-end"><strong>Total:</strong></td>
                            <td class="text-end"><strong>${{ "%.2f"|format(invoice.total) }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            {% if invoice.notes %}
                <div class="mt-4">
                    <h5>Notas</h5>
                    <p>{{ invoice.notes }}</p>
                </div>
            {% endif %}
            
            <div class="mt-4 text-center">
                <p>¡Gracias por su compra!</p>
            </div>
        </div> {# invoice-content-layer #}
    </div> {# card-body #}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar la venta #{{ invoice.number }}?</p>
                <p>Esta acción devolverá los productos al inventario.</p>
                <p class="text-danger">Esta acción no se deshace.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{{ url_for('invoice_delete', id=invoice.id) }}" method="post">
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.utc-datetime').forEach(el => {
      const iso = el.getAttribute('data-utc');
      if(!iso) return;
      const d = new Date(iso + (iso.endsWith('Z') ? '' : 'Z'));
      const opts = { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' };
      el.textContent = d.toLocaleString(undefined, opts);
    });
  });
</script>
{% endblock %}
