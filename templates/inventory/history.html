{% extends 'layout.html' %}

{% block title %}Historial de Inventarios - Green-POS{% endblock %}

{% block page_title %}Historial de Inventarios{% endblock %}

{% block page_info %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Inicio</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('inventory.pending') }}">Inventario</a></li>
    <li class="breadcrumb-item active">Historial</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<!-- Filtros -->
<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-3">
        <label for="start_date" class="form-label">Fecha Inicio</label>
        <input type="date" class="form-control" id="start_date" name="start_date" 
               value="{{ start_date_str or '' }}">
      </div>
      <div class="col-md-3">
        <label for="end_date" class="form-label">Fecha Fin</label>
        <input type="date" class="form-control" id="end_date" name="end_date" 
               value="{{ end_date_str or '' }}">
      </div>
      <div class="col-md-4">
        <label for="product_id" class="form-label">Producto</label>
        <select class="form-select" id="product_id" name="product_id">
          <option value="">Todos los productos</option>
          {% for product in products %}
          <option value="{{ product.id }}" {% if product_id and product.id == product_id|int %}selected{% endif %}>
            {{ product.code }} - {{ product.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-search"></i> Filtrar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Historial agrupado por fecha -->
{% if inventories_by_date %}
  {% for date, invs in inventories_by_date.items() %}
  <div class="card mb-3">
    <div class="card-header bg-light">
      <h5 class="mb-0">
        <i class="bi bi-calendar3"></i> {{ date }}
        <small class="text-muted ms-2">({{ invs|length }} productos inventariados)</small>
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead>
            <tr>
              <th>Producto</th>
              <th class="text-center">Stock Anterior</th>
              <th class="text-center">Contado</th>
              <th class="text-center">Diferencia</th>
              <th>Usuario</th>
              <th>Hora</th>
            </tr>
          </thead>
          <tbody>
            {% for inv in invs %}
            <tr>
              <td>
                <small class="text-muted">{{ inv.product.code }}</small><br>
                {{ inv.product.name }}
              </td>
              <td class="text-center">
                <span class="badge bg-secondary">{{ inv.previous_stock }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-primary">{{ inv.new_stock }}</span>
              </td>
              <td class="text-center">
                {% set diff = inv.new_stock - inv.previous_stock %}
                {% if diff == 0 %}
                  <span class="badge bg-success">Sin diferencia</span>
                {% elif diff > 0 %}
                  <span class="badge bg-info">+{{ diff }}</span>
                {% else %}
                  <span class="badge bg-warning">{{ diff }}</span>
                {% endif %}
              </td>
              <td><small>{{ inv.user.username if inv.user else 'Sistema' }}</small></td>
              <td><small class="text-muted">{{ inv.created_at.strftime('%I:%M %p') }}</small></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No se encontraron inventarios con los filtros seleccionados.
  </div>
{% endif %}
{% endblock %}
