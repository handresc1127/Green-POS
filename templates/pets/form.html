{% extends 'layout.html' %}
{% block title %}{{ pet and 'Editar Mascota' or 'Nueva Mascota' }}{% endblock %}
{% block page_title %}{{ pet and 'Editar Mascota' or 'Nueva Mascota' }}{% endblock %}
{% block content %}
<form method="post" class="row g-3" id="petForm">
  <div class="col-md-6">
    <label class="form-label">Cliente</label>
    <div class="d-flex align-items-center gap-2">
      <div data-customer-field="display" id="customerNameDisplay" class="form-control bg-light" style="height:auto; min-height:38px; display:flex; align-items:center;">
        {% if pet %}
          {{ pet.customer.name }} ({{ pet.customer.document }})
        {% elif default_customer %}
          {{ default_customer.name }} ({{ default_customer.document }})
        {% else %}
          <span class="text-muted">Seleccione un cliente…</span>
        {% endif %}
      </div>
      <button type="button" data-open="customer-modal" class="btn btn-outline-primary btn-sm"><i class="bi bi-search"></i></button>
    </div>
    <input type="hidden" name="customer_id" data-customer-field="id" id="customer_id" value="{% if pet %}{{ pet.customer_id }}{% elif default_customer %}{{ default_customer.id }}{% endif %}" required>
  </div>
  <div class="col-md-6">
    <label class="form-label">Nombre Mascota</label>
    <input type="text" name="name" class="form-control" value="{{ pet.name if pet else ''}}" required>
  </div>
  <div class="col-md-4">
    <label class="form-label">Especie</label>
    <input type="text" name="species" class="form-control" value="{{ pet.species if pet else ''}}">
  </div>
  <div class="col-md-4">
    <label class="form-label">Raza</label>
    <input type="text" name="breed" class="form-control" value="{{ pet.breed if pet else ''}}">
  </div>
  <div class="col-md-4">
    <label class="form-label">Color</label>
    <input type="text" name="color" class="form-control" value="{{ pet.color if pet else ''}}">
  </div>
  <div class="col-md-4">
    <label class="form-label">Sexo</label>
    <select name="sex" class="form-select">
      <option value="">--</option>
      <option value="Macho" {% if (pet and pet.sex=='Macho') or (not pet) %}selected{% endif %}>Macho</option>
      <option value="Hembra" {% if pet and pet.sex=='Hembra' %}selected{% endif %}>Hembra</option>
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Fecha Nacimiento</label>
    <input type="date" name="birth_date" id="birth_date" class="form-control" value="{% if pet and pet.birth_date %}{{ pet.birth_date.strftime('%Y-%m-%d') }}{% endif %}">
  </div>
  <div class="col-md-2">
    <label class="form-label">Edad (años)</label>
    <input type="text" id="age_display" class="form-control" value="{% if pet and pet.computed_age is not none %}{{ pet.computed_age }}{% endif %}" readonly>
  </div>
  <div class="col-md-2">
    <label class="form-label">Peso (kg)</label>
    <input type="number" step="0.01" name="weight_kg" class="form-control" value="{{ pet.weight_kg if pet and pet.weight_kg is not none else ''}}" min="0">
  </div>
  <div class="col-12">
    <label class="form-label">Notas</label>
    <textarea name="notes" class="form-control" rows="3">{{ pet.notes if pet else ''}}</textarea>
  </div>
  <div class="col-12">
    <button class="btn btn-primary">Guardar</button>
    <a href="{{ url_for('pet_list') }}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>
{% include 'partials/customer_modal.html' %}
{% endblock %}

{% block extra_js %}
<script>
 document.addEventListener('DOMContentLoaded', () => {
   const form = document.getElementById('petForm');
   const customerIdInput = document.querySelector('[data-customer-field="id"]');
   form.addEventListener('submit', function(e){
     if(!customerIdInput.value){
       e.preventDefault();
       alert('Debe seleccionar un cliente.');
     }
   });
   const birthInput = document.getElementById('birth_date');
   const ageDisplay = document.getElementById('age_display');
   function calcAge(){
     if(!birthInput.value){ ageDisplay.value=''; return; }
     const b = new Date(birthInput.value+'T00:00:00');
     const today = new Date();
     let age = today.getFullYear() - b.getFullYear();
     const m = today.getMonth() - b.getMonth();
     if (m < 0 || (m === 0 && today.getDate() < b.getDate())) age--;
     ageDisplay.value = age;
   }
   birthInput && birthInput.addEventListener('change', calcAge);
   calcAge();
 });
</script>
{% endblock %}
