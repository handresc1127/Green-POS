{% extends 'layout.html' %}
{% block title %}Mascotas{% endblock %}
{% block page_title %}Mascotas{% endblock %}
{% block page_actions %}
<a href="{{ url_for('pet_new') }}" class="btn btn-success"><i class="bi bi-plus-circle"></i> Nueva Mascota</a>
{% endblock %}
{% block content %}
<div class="row g-3 mb-3 align-items-end">
  <div class="col-md-4">
    <label class="form-label d-block">Filtro Cliente</label>
    <div class="input-group">
  <span id="customerFilterDisplay" data-lock-display="1" class="form-control bg-light {% if not selected_customer %}text-muted{% endif %}">
        {% if selected_customer %}
          {{ selected_customer.name }}{% if selected_customer.document %} ({{ selected_customer.document }}){% endif %}
        {% else %}
          (Todos los clientes)
        {% endif %}
      </span>
      <button type="button" class="btn btn-outline-primary" data-open="customer-modal"><i class="bi bi-search"></i></button>
      {% if selected_customer %}
      <button type="button" id="clearCustomerFilter" class="btn btn-outline-secondary" title="Limpiar filtro"><i class="bi bi-x"></i></button>
      {% endif %}
    </div>
  <input type="hidden" id="customerFilterId" data-customer-field="id" value="{% if selected_customer %}{{ selected_customer.id }}{% endif %}">
  </div>
  <div class="col-md-8 text-end">
    {% if selected_customer %}
      <small class="text-muted">Mostrando mascotas de <strong>{{ selected_customer.name }}</strong>. Total: {{ pets|length }}</small>
    {% else %}
      <small class="text-muted">Mostrando todas las mascotas. Total: {{ pets|length }}</small>
    {% endif %}
  </div>
</div>
<table class="table table-striped">
  <thead>
    <tr>
      <th>#</th><th>Nombre</th><th>Cliente</th><th>Especie</th><th>Raza</th><th>Nacimiento / Edad</th><th>Peso</th><th></th>
    </tr>
  </thead>
  <tbody>
    {% for p in pets %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ p.name }}</td>
        <td>{{ p.customer.name }}</td>
        <td>{{ p.species }}</td>
        <td>{{ p.breed or '' }}</td>
        <td>
          {% if p.birth_date %}
            {{ p.birth_date.strftime('%d/%m/%Y') }}<br>
            <small class="text-muted">{{ p.computed_age }} año{% if p.computed_age != 1 %}s{% endif %}</small>
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </td>
        <td>{{ p.weight_kg or '' }}</td>
        <td class="text-end">
          <a href="{{ url_for('pet_edit', id=p.id) }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
          {% if current_user.role == 'admin' %}
          <form action="{{ url_for('pet_delete', id=p.id) }}" method="post" class="d-inline" onsubmit="return confirm('Eliminar mascota?')">
            <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
          </form>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    {% if pets|length == 0 %}
      <tr><td colspan="8" class="text-center text-muted">Sin mascotas</td></tr>
    {% endif %}
  </tbody>
</table>
{% include 'partials/customer_modal.html' %}
{% endblock %}

{% block extra_js %}
<script>
  function go(customerId){
    const base = "{{ url_for('pet_list') }}";
    const url = customerId ? base + '?customer_id=' + encodeURIComponent(customerId) : base;
    window.location.href = url;
  }
  window.addEventListener('customer:selected', e => {
    const {id} = e.detail; // sólo redirigir; la vista volverá renderizada fija desde servidor
    go(id);
  });
  const clearBtn = document.getElementById('clearCustomerFilter');
  if(clearBtn){ clearBtn.addEventListener('click', ()=> go(null)); }
</script>
{% endblock %}
