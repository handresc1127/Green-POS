{# Modal reutilizable de selección de cliente #}
<div class="modal fade" id="customerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seleccionar Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="customerSearch" placeholder="Buscar por nombre o documento">
          </div>
        </div>
        <div class="table-responsive" style="max-height:320px; overflow-y:auto;">
          <table class="table table-hover table-sm">
            <thead>
              <tr><th>Nombre</th><th>Documento</th><th>Email / Teléfono</th><th></th></tr>
            </thead>
            <tbody id="customersList">
              {% for c in customers %}
              <tr class="customer-row" style="cursor:pointer" data-id="{{ c.id }}" data-name="{{ c.name }}" data-document="{{ c.document }}">
                <td>{{ c.name }}</td>
                <td>{{ c.document }}</td>
                <td>{{ c.email or c.phone or '' }}</td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-outline-primary select-customer-btn" data-id="{{ c.id }}" data-name="{{ c.name }}" data-document="{{ c.document }}">
                    <i class="bi bi-check2"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{# Script reutilizable (solo define comportamiento si no se ha inicializado) #}
<script>
 (function(){
  if(window.__customerModalInit) return; // evitar doble binding si se incluye dos veces
  window.__customerModalInit = true;
  function initCustomerModal(){
    console.debug('[ClienteModal] Inicializando modal de clientes');
    const modalEl = document.getElementById('customerModal');
    if(!modalEl){
      console.warn('[ClienteModal] No se encontró #customerModal');
      return;
    }
    // A11y baseline
    modalEl.setAttribute('role','dialog');
    modalEl.setAttribute('aria-modal','true');
    modalEl.setAttribute('aria-labelledby','customerModalTitle');
    const titleEl = modalEl.querySelector('.modal-title');
    if(titleEl) titleEl.id = 'customerModalTitle';
    let customerModal = null;
    let lastOpener = null;
    let focusableSelectors = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    let firstFocus = null;
    let lastFocus = null;
    if (window.bootstrap && bootstrap.Modal) {
      customerModal = new bootstrap.Modal(modalEl);
    } else {
      customerModal = {
        show(){
          modalEl.style.display='block';
          modalEl.classList.add('show');
          modalEl.removeAttribute('aria-hidden');
        },
        hide(){
          if (modalEl.contains(document.activeElement)) {
            document.activeElement.blur();
          }
            if (lastOpener) { try { lastOpener.focus(); } catch(_) {} }
          modalEl.classList.remove('show');
          requestAnimationFrame(()=>{
            modalEl.setAttribute('aria-hidden','true');
            setTimeout(()=>modalEl.style.display='none',150);
          });
        }
      };
    }
    const searchInput = document.getElementById('customerSearch');
    const rowsContainer = document.getElementById('customersList');
    const openButtons = document.querySelectorAll('[data-open="customer-modal"]');
    if(!rowsContainer){
      console.warn('[ClienteModal] No se encontró #customersList');
      return;
    }
    function refreshFocusables(){
      const list = modalEl.querySelectorAll(focusableSelectors);
      firstFocus = list[0];
      lastFocus = list[list.length -1];
    }
    openButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        lastOpener = btn;
        if(searchInput){
          searchInput.value='';
          rowsContainer.querySelectorAll('tr').forEach(r=>r.style.display='');
        }
        customerModal.show();
        setTimeout(()=>{ if(searchInput) searchInput.focus(); refreshFocusables(); }, 200);
      });
    });
    // Debounce búsqueda
    if (searchInput) {
      let debounceTimer=null;
      searchInput.addEventListener('input', function(){
        clearTimeout(debounceTimer);
        const self=this;
        debounceTimer=setTimeout(()=>{
          const term = self.value.toLowerCase();
          rowsContainer.querySelectorAll('tr').forEach(tr => {
            const name = tr.cells[0].textContent.toLowerCase();
            const doc = tr.cells[1].textContent.toLowerCase();
            tr.style.display = (name.includes(term) || doc.includes(term)) ? '' : 'none';
          });
        },120);
      });
    }
    function selectCustomer(id, name, documentId){
      console.debug('[ClienteModal] Cliente seleccionado', id, name);
      const hiddenInput = document.querySelector('[data-customer-field="id"]');
      const display = document.querySelector('[data-customer-field="display"]');
      if(hiddenInput) hiddenInput.value = id;
      if(display){
        display.textContent = name + (documentId ? ' (' + documentId + ')' : '');
        display.classList.remove('text-muted');
      }
      customerModal.hide();
      window.dispatchEvent(new CustomEvent('customer:selected', { detail:{ id, name, document: documentId }}));
    }
    rowsContainer.addEventListener('click', e => {
      const btn = e.target.closest('.select-customer-btn');
      if(btn){
        selectCustomer(btn.dataset.id, btn.dataset.name, btn.dataset.document);
        return;
      }
      const tr = e.target.closest('tr.customer-row');
      if(tr){
        selectCustomer(tr.dataset.id, tr.dataset.name, tr.dataset.document);
      }
    });
    // Navegación teclado (flechas + Enter)
    let activeRowIndex = -1;
    function visibleRows(){
      return Array.from(rowsContainer.querySelectorAll('tr.customer-row')).filter(r=>r.style.display!== 'none');
    }
    function highlightRow(idx){
      const rows = visibleRows();
      rows.forEach(r=>r.classList.remove('table-active'));
      if(rows[idx]){ rows[idx].classList.add('table-active'); rows[idx].scrollIntoView({block:'nearest'}); }
    }
    modalEl.addEventListener('keydown', e => {
      if(e.key === 'Escape'){ customerModal.hide(); if(lastOpener) { try { lastOpener.focus(); } catch(_){}} }
      const rows = visibleRows();
      if(!rows.length) return;
      if(e.key === 'ArrowDown') { e.preventDefault(); activeRowIndex = (activeRowIndex +1) % rows.length; highlightRow(activeRowIndex); }
      else if(e.key === 'ArrowUp') { e.preventDefault(); activeRowIndex = (activeRowIndex -1 + rows.length) % rows.length; highlightRow(activeRowIndex); }
      else if(e.key === 'Enter' && activeRowIndex >=0){ e.preventDefault(); const r=rows[activeRowIndex]; selectCustomer(r.dataset.id, r.dataset.name, r.dataset.document); }
      else if(e.key === 'Tab'){ // focus trap
        const focs = Array.from(modalEl.querySelectorAll(focusableSelectors)).filter(el=>!el.disabled && el.offsetParent!==null);
        if(!focs.length) return;
        const first = focs[0];
        const last = focs[focs.length-1];
        if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
        else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
      }
    });
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initCustomerModal);
  } else {
    initCustomerModal();
  }
 })();
</script>
