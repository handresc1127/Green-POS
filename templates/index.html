{% extends 'layout.html' %}

{% block title %}Inicio - Green-POS{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="row" id="dashboardStatsRow">
    <div class="col-md-4 mb-4" id="productsStatCol">
        <div class="card bg-primary text-white" id="productsStatCard">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title" id="productsStatTitle">Productos</h5>
                        <h2 class="mb-0" id="productsStatCount">{{ product_count }}</h2>
                    </div>
                    <div>
                        <i class="bi bi-box-seam fs-1" id="productsStatIcon"></i>
                    </div>
                </div>
                <a href="{{ url_for('products.list') }}" class="text-white" id="viewAllProductsLink">Ver todos <i class="bi bi-arrow-right"></i></a>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4" id="customersStatCol">
        <div class="card bg-success text-white" id="customersStatCard">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title" id="customersStatTitle">Clientes</h5>
                        <h2 class="mb-0" id="customersStatCount">{{ customer_count }}</h2>
                    </div>
                    <div>
                        <i class="bi bi-people fs-1" id="customersStatIcon"></i>
                    </div>
                </div>
                {# Temporary: Show customer count until customers.list is available #}
                <a href="{{ url_for('customers.list') }}" class="text-white" id="viewAllCustomersLink">Ver todos <i class="bi bi-arrow-right"></i></a>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4" id="salesStatCol">
        <div class="card bg-info text-white" id="salesStatCard">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title" id="salesStatTitle">Ventas</h5>
                        <h2 class="mb-0" id="salesStatCount">{{ invoice_count }}</h2>
                    </div>
                    <div>
                        <i class="bi bi-receipt fs-1" id="salesStatIcon"></i>
                    </div>
                </div>
                <a href="{{ url_for('invoices.list') }}" class="text-white" id="viewAllSalesLink">Ver todas <i class="bi bi-arrow-right"></i></a>
            </div>
        </div>
    </div>
</div>

<div class="row" id="dashboardDetailsRow">
    <!-- Left Column: Recent Invoices + Upcoming Appointments -->
    <div class="col-md-6 mb-4" id="leftColumn">
        <!-- Recent Invoices -->
        <div class="card mb-4" id="recentInvoicesCard">
            <div class="card-header bg-light" id="recentInvoicesHeader">
                <h5 class="mb-0" id="recentInvoicesTitle">Ventas Recientes</h5>
            </div>
            <div class="card-body" id="recentInvoicesBody">
                {% if recent_invoices %}
                    <div class="table-responsive" id="recentInvoicesTableContainer">
                        <table class="table table-hover table-sm small" id="recentInvoicesTable">
                            <thead id="recentInvoicesTableHead">
                                <tr>
                                    <th id="recentInvoicesHeaderNumber">#</th>
                                    <th id="recentInvoicesHeaderCustomer">Cliente</th>
                                    <th id="recentInvoicesHeaderDate">Fecha</th>
                                    <th id="recentInvoicesHeaderTotal">Total</th>
                                    <th id="recentInvoicesHeaderActions"></th>
                                </tr>
                            </thead>
                            <tbody id="recentInvoicesTableBody">
                                {% for invoice in recent_invoices %}
                                <tr id="recentInvoiceRow-{{ invoice.id }}">
                                    <td id="recentInvoiceNumber-{{ invoice.id }}">{{ invoice.number }}</td>
                                    <td id="recentInvoiceCustomer-{{ invoice.id }}">{{ invoice.customer.name }}</td>
                                    <td id="recentInvoiceDate-{{ invoice.id }}"><span class="utc-date" data-utc="{{ invoice.date.isoformat() }}">{{ invoice.date.isoformat() }}</span></td>
                                    <td id="recentInvoiceTotal-{{ invoice.id }}">{{ invoice.total | currency_co }}</td>
                                    <td id="recentInvoiceActions-{{ invoice.id }}">
                                        <a href="{{ url_for('invoices.view', id=invoice.id) }}" 
                                           class="btn btn-sm btn-outline-primary"
                                           id="viewInvoiceBtn-{{ invoice.id }}">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted" id="recentInvoicesEmptyState">No hay ventas recientes.</p>
                {% endif %}
            </div>
            <div class="card-footer bg-light" id="recentInvoicesFooter">
                <a href="{{ url_for('invoices.list') }}" class="btn btn-sm btn-outline-secondary" id="viewAllInvoicesBtn">Ver todas</a>
                <a href="{{ url_for('invoices.new') }}" class="btn btn-sm btn-primary float-end" id="newInvoiceBtn">Nueva Venta</a>
            </div>
        </div>

        <!-- Upcoming Appointments -->
        <div class="card" id="upcomingAppointmentsCard">
            <div class="card-header bg-light" id="upcomingAppointmentsHeader">
                <h5 class="mb-0" id="upcomingAppointmentsTitle">Pr贸ximas Citas (Top 10)</h5>
            </div>
            <div class="card-body" id="upcomingAppointmentsBody">
                {% if upcoming_appointments %}
                    <div class="table-responsive" id="upcomingAppointmentsTableContainer">
                        <table class="table table-hover table-sm small" id="upcomingAppointmentsTable">
                            <thead id="upcomingAppointmentsTableHead">
                                <tr>
                                    <th id="upcomingAppointmentsHeaderPet">Mascota</th>
                                    <th id="upcomingAppointmentsHeaderBreed">Raza</th>
                                    <th id="upcomingAppointmentsHeaderCustomer">Cliente</th>
                                    <th id="upcomingAppointmentsHeaderDate">Fecha</th>
                                    <th id="upcomingAppointmentsHeaderTime">Hora</th>
                                    <th id="upcomingAppointmentsHeaderActions"></th>
                                </tr>
                            </thead>
                            <tbody id="upcomingAppointmentsTableBody">
                                {% for appointment in upcoming_appointments %}
                                <tr id="upcomingAppointmentRow-{{ appointment.id }}">
                                    <td id="upcomingAppointmentPet-{{ appointment.id }}">
                                        {{ appointment.pet.name if appointment.pet else '-' }}
                                    </td>
                                    <td id="upcomingAppointmentBreed-{{ appointment.id }}">
                                        <small class="text-muted">
                                            {{ appointment.pet.breed if (appointment.pet and appointment.pet.breed) else '-' }}
                                        </small>
                                    </td>
                                    <td id="upcomingAppointmentCustomer-{{ appointment.id }}">
                                        {{ appointment.customer.name if appointment.customer else '-' }}
                                    </td>
                                    <td id="upcomingAppointmentDate-{{ appointment.id }}">
                                        {% if appointment.scheduled_at %}
                                            {{ appointment.scheduled_at.strftime('%d/%m/%Y') }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td id="upcomingAppointmentTime-{{ appointment.id }}">
                                        {% if appointment.scheduled_at %}
                                            {{ appointment.scheduled_at.strftime('%I:%M %p') }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td id="upcomingAppointmentActions-{{ appointment.id }}">
                                        {# <a href="{{ url_for('services.appointment_view', id=appointment.id) }}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Ver detalles"
                                           id="viewUpcomingAppointmentBtn-{{ appointment.id }}">
                                            <i class="bi bi-eye"></i>
                                        </a> #}
                                        <span class="text-muted small">ID: {{ appointment.id }}</span>
                                        {% if appointment.customer and appointment.customer.phone %}
                                        {% set phone_clean = appointment.customer.phone.replace(' ', '').replace('-', '') %}
                                        {% set first_name = appointment.customer.name.split()[0] if appointment.customer.name else '' %}
                                        {% set pet_name = appointment.pet.name if appointment.pet else 'tu mascota' %}
                                        {% set fecha = appointment.scheduled_at.strftime('%d/%m/%Y') if appointment.scheduled_at else 'Por confirmar' %}
                                        {% set hora = appointment.scheduled_at.strftime('%I:%M %p') if appointment.scheduled_at else 'Por confirmar' %}
                                        {% set mensaje = 'Hola ' ~ first_name ~ '!%0ATe saludamos desde *Pet Verde*%0A%0ARecuerda la cita con nuestra groomer para *' ~ pet_name ~ '*%0A%0AFecha: ' ~ fecha ~ '%0AHora: ' ~ hora ~ '%0A%0AGracias por preferirnos!' %}
                                        <a href="https://wa.me/+57{{ phone_clean }}?text={{ mensaje }}" 
                                           class="btn btn-sm btn-outline-success" 
                                           target="_blank"
                                           title="Confirmar cita por WhatsApp"
                                           id="whatsappUpcomingAppointmentBtn-{{ appointment.id }}">
                                            <i class="bi bi-whatsapp"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted" id="upcomingAppointmentsEmptyState">No hay citas pendientes.</p>
                {% endif %}
            </div>
            <div class="card-footer bg-light" id="upcomingAppointmentsFooter">
                {# <a href="{{ url_for('services.appointment_list') }}" class="btn btn-sm btn-outline-secondary" id="viewAllAppointmentsBtn">Ver todas</a>
                <a href="{{ url_for('services.new') }}" class="btn btn-sm btn-primary float-end" id="newAppointmentBtn">Nueva Cita</a> #}
                <span class="text-muted small">M贸dulo de servicios en migraci贸n</span>
            </div>
        </div>
    </div>
    
    <!-- Right Column: Low Stock Products -->
    <div class="col-md-6 mb-4" id="lowStockProductsCol">
        <div class="card" id="lowStockProductsCard">
            <div class="card-header bg-light" id="lowStockProductsHeader">
                <h5 class="mb-0" id="lowStockProductsTitle">Productos con Poco Stock (Top 20)</h5>
            </div>
            <div class="card-body p-2" id="lowStockProductsBody">
                {% if low_stock_products %}
                <div class="table-responsive" id="lowStockProductsTableContainer">
                    <table class="table table-hover table-sm mb-0" id="lowStockProductsTable" style="font-size: 0.85rem;">
                        <thead id="lowStockProductsTableHead">
                            <tr>
                                <th id="lowStockProductsHeaderCode" style="width: 15%;">C贸digo</th>
                                <th id="lowStockProductsHeaderName" style="width: 50%;">Producto</th>
                                <th id="lowStockProductsHeaderStock" style="width: 10%;" class="text-center">Stock</th>
                                <th id="lowStockProductsHeaderSales" style="width: 10%;" class="text-center">Ventas</th>
                                <th id="lowStockProductsHeaderActions" style="width: 15%;"></th>
                            </tr>
                        </thead>
                        <tbody id="lowStockProductsTableBody">
                            {% for product in low_stock_products %}
                            <tr id="lowStockProductRow-{{ product.id }}">
                                <td id="lowStockProductCode-{{ product.id }}" class="text-muted">{{ product.code }}</td>
                                <td id="lowStockProductName-{{ product.id }}" class="text-truncate" style="max-width: 200px;" title="{{ product.name }}">{{ product.name }}</td>
                                <td id="lowStockProductStock-{{ product.id }}" class="text-center">
                                    {% set badge_class = 'success' %}
                                    {% if product.stock <= 0 %}
                                        {% set badge_class = 'danger' %}
                                    {% elif product.stock <= 3 %}
                                        {% set badge_class = 'warning' %}
                                    {% elif product.stock <= 5 %}
                                        {% set badge_class = 'info' %}
                                    {% endif %}
                                    <span class="badge bg-{{ badge_class }}" id="lowStockProductBadge-{{ product.id }}">{{ product.stock }}</span>
                                </td>
                                <td id="lowStockProductSales-{{ product.id }}" class="text-center">
                                    <span class="badge bg-secondary" id="lowStockProductSalesBadge-{{ product.id }}">{{ product.sales_count or 0 }}</span>
                                </td>
                                <td id="lowStockProductActions-{{ product.id }}" class="text-center">
                                    {% if current_user.is_authenticated and current_user.role == 'admin' %}
                                        <a href="{{ url_for('products.edit', id=product.id) }}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Editar producto"
                                           id="editLowStockProductBtn-{{ product.id }}">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="text-muted" id="lowStockProductsEmptyState">No hay productos con poco stock.</p>
                {% endif %}
            </div>
             {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <div class="card-footer bg-light" id="lowStockProductsFooter">
                    <a href="{{ url_for('products.list') }}" class="btn btn-sm btn-outline-secondary" id="viewAllProductsBtn">Ver todos</a>
                    <a href="{{ url_for('products.new') }}" class="btn btn-sm btn-primary float-end" id="newProductBtn">Nuevo Producto</a>
                </div>
             {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const dateEls = document.querySelectorAll('.utc-date');
    dateEls.forEach(el => {
      const iso = el.getAttribute('data-utc');
      if(!iso) return;
      const d = new Date(iso + (iso.endsWith('Z') ? '' : 'Z'));
      el.textContent = d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
    });
  });
</script>
{% endblock %}
