{% extends 'layout.html' %}
{% block title %}Nueva Cita{% endblock %}
{% block page_title %}Nueva Cita{% endblock %}
{% block extra_js %}
<script>
// Refactor: módulo aislado para el formulario de servicios
window.ServiceForm = (function(){
  // Fallback labels solo para códigos legacy; normalmente usamos el texto de la opción seleccionada
  const FALLBACK_LABELS = {bath:'Baño', grooming:'Grooming / Estética', both:'Baño y Grooming', other:'Servicio Especial'};
  let lastPetsCustomerId = null;

  function qs(id){ return document.getElementById(id); }

  function currentCustomerId(){ const h = qs('customer_id'); return h && h.value ? h.value : null; }

  function buildConsent(){
    const tplEl = qs('consent_template');
    const template = tplEl ? tplEl.value : '';
    if(!template) return '';
    const display = qs('customerDisplay');
    const name = (display && (display.dataset.name || display.textContent.replace('(Sin seleccionar)','').trim())) || '';
    const doc = (display && display.dataset.document) || '';
    const petSel = qs('pet_id');
    let petName='';
    if(petSel && petSel.selectedIndex >=0){
      const opt = petSel.options[petSel.selectedIndex];
      if(opt && opt.text){ petName = opt.text.split(' (')[0]; }
    }
    // Determinar etiquetas servicio (multi)
    let serviceTypeLabel = 'Servicio';
    const selectedCards = document.querySelectorAll('.service-type-card.selected');
    if(selectedCards.length){
      const labels = Array.from(selectedCards).map(c=>{
        const lbl = c.querySelector('[data-label]');
        return lbl? lbl.textContent.trim():'';
      }).filter(Boolean);
      if(labels.length){ serviceTypeLabel = labels.join(', '); }
    }
    return template
      .replace(/\{\{customer_name\}\}/g, name)
      .replace(/\{\{customer_document\}\}/g, doc)
      .replace(/\{\{pet_name\}\}/g, petName)
      .replace(/\{\{service_type_label\}\}/g, serviceTypeLabel);
  }

  function fillConsent(){
  const area = qs('consent_text');
  if(!area || area.dataset.dirty==='1'){ return; }
  const txt = buildConsent();
  if(txt && area.value.trim()!==txt.trim()){ area.value = txt; }
  // Auto ajustar altura
  if(area){ autoGrow(area); }
  }

  function loadPets(){
    const cid = currentCustomerId();
    const sel = qs('pet_id');
    if(!sel) return;
    sel.innerHTML = '<option value="">Cargando...</option>';
    if(!cid){ sel.innerHTML='<option value="">-- Seleccione Mascota --</option>'; return; }
    console.debug('[Servicio] loadPets() para', cid);
    fetch(`/api/pets/by_customer/${cid}`)
      .then(r=>r.json())
      .then(data=>{
        sel.innerHTML = '<option value="">-- Seleccione Mascota --</option>';
        if(!Array.isArray(data) || data.length===0){
          sel.innerHTML = '<option value="">-- Sin mascotas para este cliente --</option>';
          return;
        }
        data.forEach(p=>{
          const opt=document.createElement('option');
          opt.value=p.id; opt.textContent=p.name + (p.breed? ' ('+p.breed+')':'');
          sel.appendChild(opt);
        });
        fillConsent();
      })
      .catch(()=>{ sel.innerHTML='<option value="">Error cargando mascotas</option>'; });
  }

  // onCustomerSelected ya no se usa; setCustomer centraliza la lógica

  function setCustomer(id, name='', doc='', opts={}){
    console.debug('[Servicio] setCustomer()', {id, name, doc, opts});
    const hidden = qs('customer_id');
    const display = qs('customerDisplay');
    if(hidden){ hidden.value = id || ''; }
    if(display){
      if(id){
        display.textContent = name + (doc? ' ('+doc+')':'' );
        display.dataset.name = name || '';
        display.dataset.document = doc || '';
        display.classList.remove('text-muted');
      } else {
        display.textContent = '(Sin seleccionar)';
        display.dataset.name='';
        display.dataset.document='';
        display.classList.add('text-muted');
      }
    }
    window.dispatchEvent(new CustomEvent('customer:selected', { detail:{ id, name, document: doc }}));
    if(id){
      if(opts.force || id === lastPetsCustomerId){
        console.debug('[Servicio] Forzando recarga de mascotas (force o mismo id)');
        loadPets();
      }
    }
  }

  function bind(){
  // Reaccionar a cambio de mascota
  ['pet_id'].forEach(id=>{ const el=qs(id); el && el.addEventListener('change', fillConsent); });
    window.addEventListener('customer:selected', e=>{ /* log opcional */ });
    // Auto-consentimiento: sin botón, se genera al inicio y al cambiar datos
    const consentArea = qs('consent_text');
    if(consentArea){
      consentArea.addEventListener('input', ()=>{ consentArea.dataset.dirty='1'; autoGrow(consentArea); });
    }
  // Binding tarjetas de tipos de servicio (delegación)
  const cardsContainer = document.getElementById('serviceTypeCards');
  console.debug('[Servicio] cardsContainer presente?', !!cardsContainer);
  const totalLabel = qs('serviceTotal');
  const dynamicHiddenContainer = document.getElementById('serviceHiddenContainer');

    function formatMoney(v){ return '$' + (Number(v)||0).toFixed(2); }

    function rebuildHidden(){
      if(!dynamicHiddenContainer) return;
      dynamicHiddenContainer.innerHTML='';
      const selected = document.querySelectorAll('.service-type-card.selected');
      selected.forEach(card=>{
        const code = card.dataset.code;
        const mode = card.dataset.mode;
        const base = parseFloat(card.dataset.base||'0');
        // price input inside card if variable
        let priceVal = base;
        const pv = card.querySelector('.variable-price-input');
        if(pv && pv.value){ priceVal = parseFloat(pv.value)||0; }
        const inpT = document.createElement('input');
        inpT.type='hidden'; inpT.name='service_types[]'; inpT.value=code; dynamicHiddenContainer.appendChild(inpT);
        const inpP = document.createElement('input');
        inpP.type='hidden'; inpP.name='service_prices[]'; inpP.value=priceVal.toFixed(2); dynamicHiddenContainer.appendChild(inpP);
        const inpM = document.createElement('input');
        inpM.type='hidden'; inpM.name='service_modes[]'; inpM.value=mode; dynamicHiddenContainer.appendChild(inpM);
      });
    }

    function updateTotal(){
      const selected = document.querySelectorAll('.service-type-card.selected');
      let total = 0;
      selected.forEach(card=>{
        const base = parseFloat(card.dataset.base||'0');
        const mode = card.dataset.mode;
        if(mode === 'variable'){
          const pv = card.querySelector('.variable-price-input');
          if(pv && pv.value){
            total += parseFloat(pv.value)||0;
          } else {
            total += base;
          }
        } else {
          total += base;
        }
      });
      if(totalLabel){ totalLabel.textContent = formatMoney(total); }
    }

    function ensureVariableInput(card){
      if(card.dataset.mode !== 'variable') return;
      let input = card.querySelector('.variable-price-input');
      if(!input){
        const wrap = document.createElement('div');
        wrap.className='w-100 mt-2';
        wrap.innerHTML = '<input type="number" step="0.01" class="form-control form-control-sm variable-price-input" placeholder="Precio" value="'+ card.dataset.base +'" aria-label="Precio variable">';
        card.appendChild(wrap);
        input = wrap.querySelector('input');
        input.addEventListener('input', ()=>{ updateTotal(); rebuildHidden(); });
        input.addEventListener('click', (e)=>{ e.stopPropagation(); });
      }
      // Solo enfocar la primera vez que se crea (si existía no interrumpimos al usuario)
      if(document.activeElement !== input){
        setTimeout(()=>{ input.focus(); input.select(); }, 30);
      }
    }

    function selectCard(card){
      if(!card || !card.classList.contains('service-type-card')) return;
      const willSelect = !card.classList.contains('selected');
      if(willSelect){
        card.classList.add('selected');
        ensureVariableInput(card);
      } else {
        card.classList.remove('selected');
        const variableInput = card.querySelector('.variable-price-input');
        if(variableInput && variableInput.parentElement){
          variableInput.parentElement.remove();
        }
      }
      const selected = card.classList.contains('selected');
      card.setAttribute('aria-pressed', selected? 'true':'false');
      card.setAttribute('aria-selected', selected? 'true':'false');
      updateTotal();
      rebuildHidden();
      fillConsent();
    }

    if(cardsContainer){
      cardsContainer.addEventListener('click', (e)=>{
        if(e.target.classList.contains('variable-price-input')) return; // no togglear al editar precio
        const card = e.target.closest('.service-type-card');
        if(card) selectCard(card);
      });
      cardsContainer.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' '){
          const card = e.target.closest('.service-type-card');
          if(card){ e.preventDefault(); selectCard(card); }
        }
      });
      console.debug('[Servicio] Listeners de delegación configurados');
    } else {
      console.warn('[Servicio] No se encontró #serviceTypeCards');
    }

  // Inicial
  updateTotal();
  }

  function init(){
    console.debug('[Servicio] Inicializando módulo ServiceForm');
  console.debug("[Servicio] Pets renderizados en servidor: count={{ pets|length }} ids={{ pets|map(attribute='id')|list|join(',') }}");
    bind();
    const cid = currentCustomerId();
    if(cid){ lastPetsCustomerId = cid; loadPets(); }
    else { fillConsent(); }

    // Ajustar altura inicial del consentimiento si ya tiene contenido
    const area = qs('consent_text');
    if(area){ autoGrow(area); }

  // Eliminada lógica de sincronización automática: el modal invoca setCustomer()
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else { init(); }

  return { fillConsent, loadPets, setCustomer };
})();
</script>
<script>
// Auto-crecimiento para consent_text (fuera del módulo por simplicidad de carga temprana)
function autoGrow(el){
  if(!el) return;
  el.style.height = 'auto';
  // Añadir un pequeño padding adicional para evitar scrollbars intermitentes
  el.style.height = (el.scrollHeight + 2) + 'px';
}
document.addEventListener('DOMContentLoaded', function(){
  var ct = document.getElementById('consent_text');
  if(ct){ autoGrow(ct); }
});
</script>
{% endblock %}
{% block content %}
<style>
  .service-type-card{cursor:pointer; transition: .15s ease-in-out; position: relative;}
  .service-type-card.selected{border:2px solid var(--bs-primary)!important; box-shadow:0 .25rem .5rem rgba(0,0,0,.1); background:#f8f9fa;}
  .service-type-card:not(.selected):hover{border-color: var(--bs-primary)!important;}
  .service-type-card.selected::after{
    content: '✓';
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--bs-success);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid white;
    z-index: 10;
  }
  /* Evitar que el usuario cambie el tamaño manualmente y que no aparezca scroll vertical */
  #consent_text{ resize: none; overflow:hidden; }
</style>
<form id="serviceForm" method="post" class="row g-3">
  <div class="col-12">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label d-block" for="customerDisplay">Cliente / Tutor</label>
        <div class="input-group">
          <span id="customerDisplay" data-customer-field="display" class="form-control bg-light {% if not (selected_customer or default_customer) %}text-muted{% endif %}" data-name="{% if selected_customer %}{{ selected_customer.name|e }}{% elif default_customer %}{{ default_customer.name|e }}{% endif %}" data-document="{% if (selected_customer and selected_customer.document) %}{{ selected_customer.document|e }}{% elif (default_customer and default_customer.document) %}{{ default_customer.document|e }}{% endif %}">
            {% if selected_customer %}
              {{ selected_customer.name }}{% if selected_customer.document %} ({{ selected_customer.document }}){% endif %}
            {% elif default_customer %}
              {{ default_customer.name }}{% if default_customer.document %} ({{ default_customer.document }}){% endif %}
            {% else %}
              (Sin seleccionar)
            {% endif %}
          </span>
          <button id="openCustomerModalBtn" type="button" class="btn btn-outline-primary" data-open="customer-modal" title="Buscar cliente">
            <i class="bi bi-search"></i>
          </button>
        </div>
        <input type="hidden" name="customer_id" id="customer_id" data-customer-field="id" value="{% if selected_customer %}{{ selected_customer.id }}{% elif default_customer %}{{ default_customer.id }}{% endif %}" required>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="pet_id">Mascota</label>
        <select name="pet_id" id="pet_id" class="form-select" required>
          <option value="">-- Seleccione Mascota --</option>
          {% if pets %}
            {% for p in pets %}
              <option value="{{ p.id }}">{{ p.name }}{% if p.breed %} ({{ p.breed }}){% endif %}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>
    </div>
  </div>
  <div class="col-12">
    <div class="row g-3">
      <div class="col-md-3 col-lg-2">
        <label class="form-label" for="scheduled_date">Fecha Programada</label>
        <input type="date" name="scheduled_date" id="scheduled_date" class="form-control" value="{{ default_scheduled_date }}">
      </div>
      <div class="col-md-3 col-lg-2">
        <label class="form-label" for="scheduled_time">Hora Programada</label>
        <input type="time" name="scheduled_time" id="scheduled_time" class="form-control" step="900" value="{{ default_scheduled_time }}">
      </div>
      <div class="col-md-6 col-lg-4">
        <label class="form-label" for="technician_input">Técnico / Estilista</label>
        <input id="technician_input" type="text" name="technician" class="form-control" placeholder="Nombre del responsable">
      </div>
    </div>
  </div>
  <div class="col-12">
  <label class="form-label">Sub-Servicios de la Cita</label>
    <div class="row g-2" id="serviceTypeCards">
      {% for t in service_types %}
      <div class="col-md-4 col-lg-3">
  <div class="service-type-card border rounded p-2 h-100" tabindex="0" role="button" aria-pressed="false" data-code="{{ t.code }}" data-mode="{{ t.pricing_mode }}" data-base="{{ t.base_price }}">
          <div class="d-flex justify-content-between align-items-start">
            <strong data-label="name" class="me-2">{{ t.name }}</strong>
            <span class="badge bg-{{ 'primary' if t.pricing_mode=='fixed' else 'warning' }}">{{ '$%.0f'|format(t.base_price) }}</span>
          </div>
          <div class="text-muted small mt-1">{{ 'Fijo' if t.pricing_mode=='fixed' else 'Variable' }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="col-12">
  <label class="form-label" for="description_input">Descripción</label>
  <textarea id="description_input" name="description" class="form-control" rows="2"></textarea>
  </div>
  <div class="col-12">
    <label class="form-label" for="consent_text">Consentimiento Informado</label>
  <textarea name="consent_text" id="consent_text" class="form-control" rows="5" placeholder="El texto se genera automáticamente al seleccionar datos; puedes editarlo."></textarea>
  <input type="hidden" id="consent_template" value="{{ consent_template }}">
  <small class="text-muted d-block mt-1">Este texto se genera automáticamente y puedes editarlo libremente.</small>
  </div>
  <div class="col-12">
    <div class="card">
      <div class="card-body d-flex flex-wrap align-items-center gap-3">
  <strong class="me-auto">Total Cita: <span id="serviceTotal" class="fs-5">$0.00</span></strong>
  <small class="text-muted">Seleccione uno o varios sub-servicios.</small>
      </div>
    </div>
    <div id="serviceHiddenContainer"></div>
  </div>
  <div class="col-12">
  <button id="saveServiceBtn" class="btn btn-primary">Guardar Cita</button>
  <a id="cancelServiceBtn" href="{{ url_for('services.appointment_list') }}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>
{% include 'partials/customer_modal.html' %}
{% endblock %}
