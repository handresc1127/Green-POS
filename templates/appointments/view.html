{% extends 'layout.html' %}
{% block title %}Cita #{{ appointment.id }}{% endblock %}
{% block content %}
<h1 class="h4">Cita #{{ appointment.id }}</h1>
<div class="mb-3">
  <a href="{{ url_for('appointment_list') }}" class="btn btn-sm btn-secondary">Volver</a>
  {% if appointment.status != 'done' and appointment.status != 'cancelled' %}
    <form action="{{ url_for('appointment_finish', id=appointment.id) }}" method="post" class="d-inline" onsubmit="return confirm('Finalizar todos los sub-servicios?');">
      <button class="btn btn-sm btn-success">Finalizar Cita</button>
    </form>
  {% endif %}
  {% if appointment.status != 'cancelled' %}
    <form action="{{ url_for('appointment_cancel', id=appointment.id) }}" method="post" class="d-inline" onsubmit="return confirm('Cancelar cita y sub-servicios?');">
      <button class="btn btn-sm btn-danger">Cancelar</button>
    </form>
  {% endif %}
</div>
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3"><strong>Mascota:</strong><br>{{ appointment.pet.name if appointment.pet else '' }}</div>
      <div class="col-md-3"><strong>Cliente:</strong><br>{{ appointment.customer.name if appointment.customer else '' }}</div>
      <div class="col-md-2"><strong>Estado:</strong><br>
        {% if appointment.status=='done' %}<span class="badge bg-success">Finalizada</span>
        {% elif appointment.status=='cancelled' %}<span class="badge bg-danger">Cancelada</span>
        {% else %}<span class="badge bg-secondary">Pendiente</span>{% endif %}
      </div>
      <div class="col-md-2"><strong>Total:</strong><br>${{ '%.0f'|format(appointment.total_price or 0) }}</div>
      <div class="col-md-2"><strong>Creada:</strong><br>{{ appointment.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
  </div>
</div>
<h5>Sub-Servicios</h5>
<table class="table table-sm table-striped align-middle">
  <thead>
    <tr>
      <th>ID</th>
      <th>Tipo</th>
      <th>Precio</th>
      <th>Estado</th>
    </tr>
  </thead>
  <tbody>
  {% for s in appointment.services %}
    <tr>
      <td>{{ s.id }}</td>
      <td>{{ s.service_type }}</td>
      <td>${{ '%.0f'|format(s.price or 0) }}</td>
      <td>
        {% if s.status=='done' %}<span class="badge bg-success">Finalizado</span>
        {% elif s.status=='cancelled' %}<span class="badge bg-danger">Cancelado</span>
        {% else %}<span class="badge bg-secondary">Pendiente</span>{% endif %}
      </td>
    </tr>
  {% else %}
    <tr><td colspan="4" class="text-center text-muted">Sin sub-servicios</td></tr>
  {% endfor %}
  </tbody>
</table>
{% endblock %}
