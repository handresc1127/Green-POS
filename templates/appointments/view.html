{% extends 'layout.html' %}
{% block title %}Cita #{{ appointment.id }}{% endblock %}
{% block content %}
<h1 class="h4">Cita #{{ appointment.id }}</h1>
<div class="mb-3">
  <a href="{{ url_for('appointment_list') }}" class="btn btn-sm btn-secondary">Volver</a>
  {% if appointment.status == 'pending' %}
    <a href="{{ url_for('appointment_edit', id=appointment.id) }}" class="btn btn-sm btn-warning">
      <i class="bi bi-pencil-square"></i> Editar
    </a>
  {% endif %}
  {% if appointment.status != 'done' and appointment.status != 'cancelled' %}
    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#finishAppointmentModal">
      <i class="bi bi-check-circle"></i> Finalizar Cita y Generar Factura
    </button>
  {% endif %}
  {% if appointment.status == 'pending' %}
    <form action="{{ url_for('appointment_cancel', id=appointment.id) }}" method="post" class="d-inline" onsubmit="return confirm('Cancelar cita y sub-servicios?');">
      <button class="btn btn-sm btn-danger">
        <i class="bi bi-x-circle"></i> Cancelar
      </button>
    </form>
  {% endif %}
</div>
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3"><strong>Mascota:</strong><br>{{ appointment.pet.name if appointment.pet else '' }}</div>
      <div class="col-md-3"><strong>Cliente:</strong><br>{{ appointment.customer.name if appointment.customer else '' }}</div>
      <div class="col-md-2"><strong>Estado:</strong><br>
        {% if appointment.status=='done' %}<span class="badge bg-success">Finalizada</span>
        {% elif appointment.status=='cancelled' %}<span class="badge bg-danger">Cancelada</span>
        {% else %}<span class="badge bg-secondary">Pendiente</span>{% endif %}
      </div>
  <div class="col-md-2"><strong>Total:</strong><br>{{ (appointment.total_price or 0)|currency_co }}</div>
  <div class="col-md-2"><strong>Factura:</strong><br>
    {% if appointment.invoice_id %}
      <a href="{{ url_for('invoice_view', id=appointment.invoice_id) }}" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-receipt"></i> Ver Factura
      </a>
    {% else %}
      <span class="badge bg-warning text-dark">Pendiente</span>
    {% endif %}
  </div>
  <div class="col-md-3"><strong>Programada:</strong><br>{% if appointment.scheduled_at %}{{ appointment.scheduled_at.strftime('%Y-%m-%d %H:%M') }}{% else %}<span class="text-muted">(No)</span>{% endif %}</div>
  <div class="col-md-3"><strong>Creada:</strong><br>{{ appointment.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
    </div>
  </div>
</div>

<!-- Notas y Consentimiento Informado -->
{% if appointment.description or appointment.consent_text %}
<div class="card mb-3">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h6 class="mb-0"><i class="bi bi-file-text"></i> Notas y Consentimiento Informado</h6>
    {% if appointment.consent_text %}
    <button onclick="printConsent()" class="btn btn-sm btn-primary">
      <i class="bi bi-printer"></i> Imprimir Consentimiento
    </button>
    {% endif %}
  </div>
  <div class="card-body">
    {% if appointment.description %}
    <div class="mb-3">
      <strong>Notas de la Cita:</strong>
      <p class="mt-2 mb-0" style="white-space: pre-wrap;">{{ appointment.description }}</p>
    </div>
    {% endif %}
    
    {% if appointment.consent_text %}
    <div id="consentSection">
      <strong>Consentimiento Informado:</strong>
      <div class="mt-2 p-3 border rounded bg-light" style="white-space: pre-wrap; font-family: 'Courier New', monospace;">{{ appointment.consent_text }}</div>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<h5>Sub-Servicios</h5>
<table class="table table-sm table-striped align-middle">
  <thead>
    <tr>
      <th>ID</th>
      <th>Tipo</th>
      <th>Precio</th>
      <th>Estado</th>
    </tr>
  </thead>
  <tbody>
  {% for s in appointment.services %}
    <tr>
      <td>{{ s.id }}</td>
      <td>{{ s.service_type }}</td>
  <td>{{ (s.price or 0)|currency_co }}</td>
      <td>
        {% if s.status=='done' %}<span class="badge bg-success">Finalizado</span>
        {% elif s.status=='cancelled' %}<span class="badge bg-danger">Cancelado</span>
        {% else %}<span class="badge bg-secondary">Pendiente</span>{% endif %}
      </td>
    </tr>
  {% else %}
    <tr><td colspan="4" class="text-center text-muted">Sin sub-servicios</td></tr>
  {% endfor %}
  </tbody>
</table>

<!-- Modal para seleccionar método de pago al finalizar cita -->
<div class="modal fade" id="finishAppointmentModal" tabindex="-1" aria-labelledby="finishAppointmentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="finishAppointmentModalLabel">
          <i class="bi bi-check-circle"></i> Finalizar Cita y Generar Factura
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('appointment_finish', id=appointment.id) }}" method="post">
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Se generará una factura con los servicios de esta cita.
          </div>
          
          <div class="mb-3">
            <label for="payment_method" class="form-label">
              <strong>Método de Pago:</strong> <span class="text-danger">*</span>
            </label>
            <select class="form-select" id="payment_method" name="payment_method" required>
              <option value="cash" selected>Efectivo</option>
              <option value="transfer">Transferencia</option>
            </select>
            <div class="form-text">
              Selecciona cómo pagará el cliente
            </div>
          </div>

          <div class="mb-3">
            <label for="discount" class="form-label">
              <strong>Descuento Especial:</strong>
            </label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" id="discount" name="discount" 
                     min="0" max="{{ appointment.total_price or 0 }}" step="100" value="0"
                     oninput="updateFinalTotal()">
            </div>
            <div class="form-text">
              Descuento promocional a aplicar (opcional)
            </div>
          </div>

          <div class="card bg-light">
            <div class="card-body">
              <h6 class="card-title">Resumen de la Cita:</h6>
              <ul class="mb-0">
                <li><strong>Mascota:</strong> {{ appointment.pet.name if appointment.pet else 'N/A' }}</li>
                <li><strong>Cliente:</strong> {{ appointment.customer.name if appointment.customer else 'N/A' }}</li>
                <li><strong>Servicios:</strong> {{ appointment.services|length }}</li>
                <li><strong>Subtotal:</strong> <span id="subtotal-display">{{ (appointment.total_price or 0)|currency_co }}</span></li>
                <li><strong>Descuento:</strong> <span id="discount-display" class="text-danger">$0</span></li>
                <li class="border-top pt-2 mt-2"><strong>Total a Pagar:</strong> <span id="total-display" class="fs-5 text-success">{{ (appointment.total_price or 0)|currency_co }}</span></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-check-circle"></i> Confirmar y Generar Factura
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Variables globales para el cálculo del total
const appointmentSubtotal = {{ appointment.total_price or 0 }};

/**
 * Actualiza el total final según el descuento aplicado
 */
function updateFinalTotal() {
    const discountInput = document.getElementById('discount');
    const discount = parseFloat(discountInput.value) || 0;
    
    // Validar que el descuento no sea mayor al subtotal
    if (discount > appointmentSubtotal) {
        discountInput.value = appointmentSubtotal;
        discount = appointmentSubtotal;
    }
    
    const finalTotal = appointmentSubtotal - discount;
    
    // Actualizar displays
    document.getElementById('discount-display').textContent = 
        new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(discount);
    
    document.getElementById('total-display').textContent = 
        new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(finalTotal);
}

/**
 * Imprime el consentimiento informado
 */
function printConsent() {
    // Obtener datos de la cita
    var appointmentId = {{ appointment.id }};
    var petName = "{{ appointment.pet.name if appointment.pet else '' }}";
    var customerName = "{{ appointment.customer.name if appointment.customer else '' }}";
    var customerDocument = "{{ appointment.customer.document if appointment.customer else '' }}";
    var consentText = {{ appointment.consent_text|tojson|safe }};
    var scheduledDate = "{% if appointment.scheduled_at %}{{ appointment.scheduled_at.strftime('%d/%m/%Y %H:%M') }}{% else %}No programada{% endif %}";
    var createdDate = "{{ appointment.created_at.strftime('%d/%m/%Y %H:%M') }}";
    var businessName = "{{ setting.business_name }}";
    var logoPath = "{{ url_for('static', filename='uploads/logo.png') }}";
    
    // Crear ventana de impresión
    var printWindow = window.open('', '_blank', 'width=800,height=600');
    
    // Generar contenido HTML para imprimir
    var printContent = '<!DOCTYPE html>' +
        '<html lang="es">' +
        '<head>' +
        '<meta charset="UTF-8">' +
        '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
        '<title>Consentimiento Informado - Cita #' + appointmentId + '</title>' +
        '<style>' +
        'body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }' +
        '.header { text-align: center; border-bottom: 2px solid #28a745; padding-bottom: 15px; margin-bottom: 20px; }' +
        '.header-title { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px; }' +
        '.header-title img { width: 50px; height: 50px; object-fit: contain; }' +
        '.header h1 { color: #28a745; margin: 0; font-size: 24px; display: inline-block; }' +
        '.header h2 { color: #666; margin: 5px 0 0 0; font-size: 16px; font-weight: normal; }' +
        '.info-section { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }' +
        '.info-row { margin-bottom: 8px; }' +
        '.info-label { font-weight: bold; display: inline-block; width: 180px; }' +
        '.consent-text { white-space: pre-wrap; line-height: 1.6; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #fff; font-size: 12px; }' +
        '.footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 11px; }' +
        '@media print { body { padding: 0; } .no-print { display: none; } }' +
        '</style>' +
        '</head>' +
        '<body>' +
        '<div class="header">' +
        '<div class="header-title">' +
        '<img src="' + logoPath + '" alt="Logo">' +
        '<h1>' + businessName + ' - Animal Center</h1>' +
        '</div>' +
        '<h2>CONSENTIMIENTO INFORMADO</h2>' +
        '</div>' +
        '<div class="info-section">' +
        '<div class="info-row"><span class="info-label">Cliente:</span><span>' + customerName + '</span></div>' +
        '<div class="info-row"><span class="info-label">Documento:</span><span>' + customerDocument + '</span></div>' +
        '<div class="info-row"><span class="info-label">Mascota:</span><span>' + petName + '</span></div>' +
        '<div class="info-row"><span class="info-label">Fecha de Cita:</span><span>' + scheduledDate + '</span></div>' +
        '</div>' +
        '<div class="consent-text">' + consentText + '</div>' +
        '<div class="footer">' +
        '<p>Documento generado el ' + new Date().toLocaleString('es-CO') + '</p>' +
        '<p>Green-POS Powered by HACC &copy; ' + new Date().getFullYear() + ' - Todos los derechos reservados</p>' +
        '</div>' +
        '<script>' +
        'window.onload = function() { window.print(); };' +
        '<\/script>' +
        '</body>' +
        '</html>';
    
    printWindow.document.write(printContent);
    printWindow.document.close();
}
</script>
{% endblock %}
