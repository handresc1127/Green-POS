{% extends 'layout.html' %}
{% block title %}Citas{% endblock %}

{% block extra_css %}
<style>
    .card-header .btn-link {
        transition: all 0.3s ease;
    }
    .card-header .btn-link:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    .collapse-icon {
        transition: transform 0.3s ease;
        display: inline-block;
    }
    .collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">Citas</h1>
  <div>
    <a href="{{ url_for('services.service_new') }}" class="btn btn-sm btn-primary me-2">
      <i class="bi bi-plus-circle"></i> Nueva Cita
    </a>
    <a href="{{ url_for('services.service_type_list') }}" class="btn btn-sm btn-outline-secondary" title="Configurar tipos de servicio">
      <i class="fas fa-cog"></i>
    </a>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-2">
      <div class="col-auto">
        <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="">-- Todos los Estados --</option>
          <option value="pending" {{ 'selected' if status=='pending' else '' }}>Pendiente</option>
          <option value="done" {{ 'selected' if status=='done' else '' }}>Finalizada</option>
          <option value="cancelled" {{ 'selected' if status=='cancelled' else '' }}>Cancelada</option>
        </select>
      </div>
      {% if status %}
      <div class="col-auto">
        <a href="{{ url_for('services.appointment_list') }}" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-x-circle"></i> Limpiar
        </a>
      </div>
      {% endif %}
    </form>
  </div>
</div>

<div class="card">
  <div class="card-body">
    {% if appointments_by_date %}
    {% for date, appointments in appointments_by_date.items() %}
    {% set should_expand = date >= today %}
    <div class="card mb-4">
      <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0 flex-grow-1">
            <button class="btn btn-link text-decoration-none text-dark w-100 text-start d-flex justify-content-between align-items-center p-0{{ ' collapsed' if not should_expand }}" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#collapse-{{ loop.index }}" 
                    aria-expanded="{{ 'true' if should_expand else 'false' }}" 
                    aria-controls="collapse-{{ loop.index }}">
              <span>
                <i class="bi bi-chevron-down collapse-icon"></i>
                <span class="formatted-date" data-date="{{ date }}">{{ date }}</span>
                <small class="text-muted ms-2">
                  ({{ appointments|length }} cita{{ 's' if appointments|length != 1 }})
                  <span class="ms-2">Total: {{ appointments|sum(attribute='total_price')|currency_co }}</span>
                </small>
              </span>
            </button>
          </h5>
          <button class="btn btn-sm btn-success ms-3 send-whatsapp-btn" 
                  data-date="{{ date }}" 
                  title="Enviar consolidado de citas por WhatsApp">
            <i class="bi bi-whatsapp"></i> Enviar Agenda
          </button>
        </div>
      </div>
      <div id="collapse-{{ loop.index }}" class="collapse{{ ' show' if should_expand }}">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Mascota</th>
                  <th>Raza</th>
                  <th>Cliente</th>
                  <th>Hora</th>
                  <th>Servicios</th>
                  <th>Total</th>

                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for a in appointments %}
                <tr>
                  <td>{{ a.id }}</td>
                  <td>{{ a.pet.name if a.pet else '' }}</td>
                  <td>
                    <small class="text-muted">{{ a.pet.breed if (a.pet and a.pet.breed) else '-' }}</small>
                  </td>
                  <td>{{ a.customer.name if a.customer else '' }}</td>
                  <td>
                    {% if a.scheduled_at %}
                      {{ a.scheduled_at.strftime('%I:%M %p') }}
                    {% else %}
                      <span class="text-muted">(No programada)</span>
                    {% endif %}
                  </td>
                  <td>{{ a.services|length }}</td>
                  <td>{{ (a.total_price or 0)|currency_co }}</td>

                  <td>
                    
                  
                    <a href="{{ url_for('services.appointment_view', id=a.id) }}" class="btn btn-sm btn-outline-primary" title="Ver detalles">
                      <i class="bi bi-eye"></i>
                    </a>
                    {% if a.customer and a.customer.phone %}
                    {% set phone_clean = a.customer.phone.replace(' ', '').replace('-', '') %}
                    {% set first_name = a.customer.name.split()[0] if a.customer.name else '' %}
                    {% set pet_name = a.pet.name if a.pet else 'tu mascota' %}
                    {% set fecha = a.scheduled_at.strftime('%d/%m/%Y') if a.scheduled_at else 'Por confirmar' %}
                    {% set hora = a.scheduled_at.strftime('%I:%M %p') if a.scheduled_at else 'Por confirmar' %}
                    {% set mensaje = 'Hola ' ~ first_name ~ '!%0ATe saludamos desde *Pet Verde*%0A%0ARecuerda la cita con nuestra groomer para *' ~ pet_name ~ '*%0A%0AFecha: ' ~ fecha ~ '%0AHora: ' ~ hora ~ '%0A%0AGracias por preferirnos!' %}
                    <a href="https://wa.me/+57{{ phone_clean }}?text={{ mensaje }}" 
                       class="btn btn-sm btn-outline-success" 
                       target="_blank"
                       title="Confirmar cita por WhatsApp">
                      <i class="bi bi-whatsapp"></i>
                    </a>
                    {% endif %}

                    {% if a.invoice_id %}
                      <a href="{{ url_for('invoices.view', id=a.invoice_id) }}" 
                         class="btn btn-sm btn-outline-success" 
                         title="Ver factura">
                        <i class="bi bi-receipt-cutoff"></i>
                      </a>
                    {% else %}
                      <span class="btn btn-sm btn-outline-secondary disabled" 
                            title="Sin factura">
                        <i class="bi bi-hourglass-split"></i>
                      </span>
                    {% endif %}

                    {% if a.status=='done' %}
                      <i class="bi bi-check-circle-fill text-success" title="Finalizada"></i>
                    {% elif a.status=='cancelled' %}
                      <i class="bi bi-x-circle-fill text-danger" title="Cancelada"></i>
                    {% else %}
                      <i class="bi bi-hourglass-split text-secondary" title="Pendiente"></i>
                    {% endif %}

                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-info">
      {% if status %}
      No se encontraron citas con el estado "{{ {'pending': 'Pendiente', 'done': 'Finalizada', 'cancelled': 'Cancelada'}.get(status, status) }}".
      {% else %}
      No hay citas registradas. <a href="{{ url_for('services.service_new') }}">Crear la primera</a>.
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Manejar la rotación del icono chevron
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
            const targetId = button.getAttribute('data-bs-target');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                targetElement.addEventListener('show.bs.collapse', () => {
                    button.classList.remove('collapsed');
                });
                
                targetElement.addEventListener('hide.bs.collapse', () => {
                    button.classList.add('collapsed');
                });
            }
        });
        
        // Formatear fechas agrupadas
        document.querySelectorAll('.formatted-date').forEach(el => {
            const date = el.getAttribute('data-date');
            if (!date) return;
            
            // Parsear la fecha como local (YYYY-MM-DD) sin conversión de zona horaria
            const [year, month, day] = date.split('-').map(Number);
            const d = new Date(year, month - 1, day);
            
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            el.textContent = d.toLocaleDateString('es-ES', options);
        });

        // ==================== WHATSAPP CONSOLIDADO ====================
        
        // Manejador de clic para botones de WhatsApp consolidado
        document.querySelectorAll('.send-whatsapp-btn').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation(); // Evitar que el collapse se abra/cierre
                
                const date = this.getAttribute('data-date');
                
                if (!date) {
                    alert('Error: Fecha no especificada');
                    return;
                }
                
                // Mostrar loader
                const originalText = this.innerHTML;
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Generando...';
                
                try {
                    // Llamar al endpoint de consolidado
                    const response = await fetch(`{{ url_for('services.appointment_whatsapp_summary') }}?date=${date}`);
                    const data = await response.json();
                    
                    if (!response.ok || !data.success) {
                        throw new Error(data.error || 'Error desconocido');
                    }
                    
                    // Construir URL de WhatsApp
                    const whatsappUrl = `https://wa.me/${data.technician_phone}?text=${data.message_text}`;
                    
                    // Abrir WhatsApp en nueva pestaña
                    window.open(whatsappUrl, '_blank');
                    
                    // Mostrar confirmación
                    setTimeout(() => {
                        alert(`Mensaje generado para ${data.technician_name}\n${data.appointment_count} cita(s) en la agenda`);
                    }, 500);
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert(`Error al generar mensaje: ${error.message}`);
                } finally {
                    // Restaurar botón
                    this.disabled = false;
                    this.innerHTML = originalText;
                }
            });
        });
    });
</script>
{% endblock %}
