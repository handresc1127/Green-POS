{% extends 'layout.html' %}
{% block title %}Editar Cita #{{ appointment.id }}{% endblock %}
{% block page_title %}Editar Cita #{{ appointment.id }}{% endblock %}
{% block extra_js %}
<script>
// Módulo para el formulario de edición de citas
window.AppointmentEditForm = (function(){
  let lastPetsCustomerId = null;
  // Servicios seleccionados inicialmente desde el servidor
  const initialServices = new Set({{ appointment.services|map(attribute='service_type')|list|tojson|safe }});

  function qs(id){ return document.getElementById(id); }

  function currentCustomerId(){ 
    return {{ appointment.customer_id }};
  }

  function buildConsent(){
    const tplEl = qs('consent_template');
    const template = tplEl ? tplEl.value : '';
    if(!template) return '';
    
    const customerName = "{{ appointment.customer.name if appointment.customer else '' }}";
    const customerDoc = "{{ appointment.customer.document if appointment.customer else '' }}";
    const petName = "{{ appointment.pet.name if appointment.pet else '' }}";
    
    // Determinar etiquetas servicio (multi)
    let serviceTypeLabel = 'Servicio';
    const selectedCards = document.querySelectorAll('.service-type-card.selected');
    if(selectedCards.length){
      const labels = Array.from(selectedCards).map(c=>{
        const lbl = c.querySelector('[data-label]');
        return lbl? lbl.textContent.trim():'';
      }).filter(Boolean);
      if(labels.length){ serviceTypeLabel = labels.join(', '); }
    }
    
    return template
      .replace(/\{\{customer_name\}\}/g, customerName)
      .replace(/\{\{customer_document\}\}/g, customerDoc)
      .replace(/\{\{pet_name\}\}/g, petName)
      .replace(/\{\{service_type_label\}\}/g, serviceTypeLabel);
  }

  function fillConsent(){
    const area = qs('consent_text');
    if(!area || area.dataset.dirty==='1'){ return; }
    const txt = buildConsent();
    if(txt && area.value.trim()!==txt.trim()){ area.value = txt; }
    if(area){ autoGrow(area); }
  }

  function bind(){
    const consentArea = qs('consent_text');
    if(consentArea){
      consentArea.addEventListener('input', ()=>{ 
        consentArea.dataset.dirty='1'; 
        autoGrow(consentArea); 
      });
    }
    
    // Binding tarjetas de tipos de servicio
    const cardsContainer = document.getElementById('serviceTypeCards');
    const totalLabel = qs('serviceTotal');
    const dynamicHiddenContainer = document.getElementById('serviceHiddenContainer');

    function formatMoney(v){ 
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0
      }).format(v);
    }

    function rebuildHidden(){
      if(!dynamicHiddenContainer) return;
      dynamicHiddenContainer.innerHTML='';
      const selected = document.querySelectorAll('.service-type-card.selected');
      
      selected.forEach(card=>{
        const code = card.dataset.code;
        const mode = card.dataset.mode;
        const base = parseFloat(card.dataset.base||'0');
        
        let priceVal = base;
        const pv = card.querySelector('.variable-price-input');
        if(pv && pv.value){ priceVal = parseFloat(pv.value)||0; }
        
        const inpT = document.createElement('input');
        inpT.type='hidden'; inpT.name='service_types[]'; inpT.value=code;
        dynamicHiddenContainer.appendChild(inpT);
        
        const inpP = document.createElement('input');
        inpP.type='hidden'; inpP.name='service_prices[]'; inpP.value=priceVal.toFixed(2);
        dynamicHiddenContainer.appendChild(inpP);
        
        const inpS = document.createElement('input');
        inpS.type='hidden'; inpS.name='service_statuses[]'; inpS.value='pending';
        dynamicHiddenContainer.appendChild(inpS);
        
        const inpId = document.createElement('input');
        inpId.type='hidden'; inpId.name='service_ids[]'; inpId.value='new';
        dynamicHiddenContainer.appendChild(inpId);
      });
    }

    function updateTotal(){
      const selected = document.querySelectorAll('.service-type-card.selected');
      let total = 0;
      selected.forEach(card=>{
        const base = parseFloat(card.dataset.base||'0');
        const mode = card.dataset.mode;
        if(mode === 'variable'){
          const pv = card.querySelector('.variable-price-input');
          if(pv && pv.value){
            total += parseFloat(pv.value)||0;
          } else {
            total += base;
          }
        } else {
          total += base;
        }
      });
      if(totalLabel){ totalLabel.textContent = formatMoney(total); }
    }

    function ensureVariableInput(card){
      if(card.dataset.mode !== 'variable') return;
      let input = card.querySelector('.variable-price-input');
      if(!input){
        const wrap = document.createElement('div');
        wrap.className='w-100 mt-2';
        wrap.innerHTML = '<input type="number" step="0.01" class="form-control form-control-sm variable-price-input" placeholder="Precio" value="'+ card.dataset.base +'" aria-label="Precio variable">';
        card.appendChild(wrap);
        input = wrap.querySelector('input');
        input.addEventListener('input', ()=>{ updateTotal(); rebuildHidden(); });
        input.addEventListener('click', (e)=>{ e.stopPropagation(); });
      }
      if(document.activeElement !== input){
        setTimeout(()=>{ input.focus(); input.select(); }, 30);
      }
    }

    function selectCard(card){
      if(!card || !card.classList.contains('service-type-card')) return;
      const willSelect = !card.classList.contains('selected');
      if(willSelect){
        card.classList.add('selected');
        ensureVariableInput(card);
      } else {
        card.classList.remove('selected');
        const variableInput = card.querySelector('.variable-price-input');
        if(variableInput && variableInput.parentElement){
          variableInput.parentElement.remove();
        }
      }
      const selected = card.classList.contains('selected');
      card.setAttribute('aria-pressed', selected? 'true':'false');
      card.setAttribute('aria-selected', selected? 'true':'false');
      updateTotal();
      rebuildHidden();
      fillConsent();
    }

    if(cardsContainer){
      cardsContainer.addEventListener('click', (e)=>{
        if(e.target.classList.contains('variable-price-input')) return;
        const card = e.target.closest('.service-type-card');
        if(card) selectCard(card);
      });
      cardsContainer.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' '){
          const card = e.target.closest('.service-type-card');
          if(card){ e.preventDefault(); selectCard(card); }
        }
      });
    }

    // Preseleccionar servicios existentes
    if(initialServices.size > 0){
      const cards = document.querySelectorAll('.service-type-card');
      cards.forEach(card => {
        const code = card.dataset.code;
        if(initialServices.has(code)){
          selectCard(card);
          // Si es variable, establecer el precio actual
          {% for service in appointment.services %}
          if(code === '{{ service.service_type }}'){
            const input = card.querySelector('.variable-price-input');
            if(input){
              input.value = {{ service.price or 0 }};
            }
          }
          {% endfor %}
        }
      });
    }

    updateTotal();
  }

  function init(){
    bind();
    const area = qs('consent_text');
    if(area){ autoGrow(area); }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else { init(); }

  return { fillConsent };
})();
</script>
<script>
function autoGrow(el){
  if(!el) return;
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight + 2) + 'px';
}
document.addEventListener('DOMContentLoaded', function(){
  var ct = document.getElementById('consent_text');
  if(ct){ autoGrow(ct); }
});
</script>
{% endblock %}
{% block content %}
<style>
  .service-type-card{cursor:pointer; transition: .15s ease-in-out; position: relative;}
  .service-type-card.selected{border:2px solid var(--bs-primary)!important; box-shadow:0 .25rem .5rem rgba(0,0,0,.1); background:#f8f9fa;}
  .service-type-card:not(.selected):hover{border-color: var(--bs-primary)!important;}
  .service-type-card.selected::after{
    content: '✓';
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--bs-success);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid white;
    z-index: 10;
  }
  #consent_text{ resize: none; overflow:hidden; }
</style>

<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('appointment_list') }}">Citas</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('appointment_view', id=appointment.id) }}">Cita #{{ appointment.id }}</a></li>
    <li class="breadcrumb-item active">Editar</li>
  </ol>
</nav>

<h1 class="h4 mb-4"><i class="bi bi-pencil-square"></i> Editar Cita #{{ appointment.id }}</h1>

<form id="appointmentEditForm" method="POST" action="{{ url_for('appointment_update', id=appointment.id) }}" class="row g-3">
  <div class="col-12">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label"><strong>Cliente / Tutor:</strong></label>
        <p class="form-control-plaintext">{{ appointment.customer.name if appointment.customer else 'N/A' }}</p>
      </div>
      <div class="col-md-6">
        <label class="form-label"><strong>Mascota:</strong></label>
        <p class="form-control-plaintext">{{ appointment.pet.name if appointment.pet else 'N/A' }}</p>
      </div>
    </div>
  </div>
  
  <div class="col-12">
    <div class="row g-3">
      <div class="col-md-3 col-lg-2">
        <label class="form-label" for="scheduled_date">Fecha Programada</label>
        <input type="date" name="scheduled_date" id="scheduled_date" class="form-control" 
               value="{% if appointment.scheduled_at %}{{ appointment.scheduled_at.strftime('%Y-%m-%d') }}{% endif %}">
      </div>
      <div class="col-md-3 col-lg-2">
        <label class="form-label" for="scheduled_time">Hora Programada</label>
        <input type="time" name="scheduled_time" id="scheduled_time" class="form-control" step="900"
               value="{% if appointment.scheduled_at %}{{ appointment.scheduled_at.strftime('%H:%M') }}{% endif %}">
      </div>
      <div class="col-md-6 col-lg-4">
        <label class="form-label" for="technician">Técnico / Estilista</label>
        <input type="text" class="form-control" id="technician" name="technician" 
               value="{{ appointment.technician or '' }}" placeholder="Nombre del responsable">
      </div>
    </div>
  </div>

  <div class="col-12">
    <label class="form-label">Sub-Servicios de la Cita</label>
    <div class="row g-2" id="serviceTypeCards">
      {% for t in service_types %}
      <div class="col-md-4 col-lg-3">
        <div class="service-type-card border rounded p-2 h-100" tabindex="0" role="button" aria-pressed="false" 
             data-code="{{ t.code }}" data-mode="{{ t.pricing_mode }}" data-base="{{ t.base_price }}">
          <div class="d-flex justify-content-between align-items-start">
            <strong data-label="name" class="me-2">{{ t.name }}</strong>
            <span class="badge bg-{{ 'primary' if t.pricing_mode=='fixed' else 'warning' }}">{{ t.base_price|currency_co }}</span>
          </div>
          <div class="text-muted small mt-1">{{ 'Fijo' if t.pricing_mode=='fixed' else 'Variable' }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div class="col-12">
    <label class="form-label" for="description">Notas de la Cita</label>
    <textarea class="form-control" id="description" name="description" rows="3">{{ appointment.description or '' }}</textarea>
    <div class="form-text">Información adicional sobre la cita, observaciones, etc.</div>
  </div>

  <div class="col-12">
    <label class="form-label" for="consent_text">Consentimiento Informado</label>
    <textarea name="consent_text" id="consent_text" class="form-control" rows="5" 
              placeholder="El texto se genera automáticamente al seleccionar datos; puedes editarlo.">{{ appointment.consent_text or '' }}</textarea>
    <input type="hidden" id="consent_template" value="{{ consent_template }}">
    <small class="text-muted d-block mt-1">Este texto se genera automáticamente y puedes editarlo libremente.</small>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-body d-flex flex-wrap align-items-center gap-3">
        <strong class="me-auto">Total Cita: <span id="serviceTotal" class="fs-5">{{ appointment.total_price|currency_co }}</span></strong>
        <small class="text-muted">Seleccione uno o varios sub-servicios.</small>
      </div>
    </div>
    <div id="serviceHiddenContainer"></div>
  </div>

  <div class="col-12">
    <button type="submit" class="btn btn-primary">
      <i class="bi bi-check-circle"></i> Guardar Cambios
    </button>
    <a href="{{ url_for('appointment_view', id=appointment.id) }}" class="btn btn-secondary">
      <i class="bi bi-x-circle"></i> Cancelar
    </a>
  </div>
</form>

{% endblock %}
