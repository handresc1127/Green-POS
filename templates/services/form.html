{% extends 'layout.html' %}
{% block title %}Nuevo Servicio{% endblock %}
{% block page_title %}Nuevo Servicio{% endblock %}
{% block extra_js %}
<script>
// Refactor: módulo aislado para el formulario de servicios
window.ServiceForm = (function(){
  // Fallback labels solo para códigos legacy; normalmente usamos el texto de la opción seleccionada
  const FALLBACK_LABELS = {bath:'Baño', grooming:'Grooming / Estética', both:'Baño y Grooming', other:'Servicio Especial'};
  let lastPetsCustomerId = null;

  function qs(id){ return document.getElementById(id); }

  function currentCustomerId(){ const h = qs('customer_id'); return h && h.value ? h.value : null; }

  function buildConsent(){
    const tplEl = qs('consent_template');
    const template = tplEl ? tplEl.value : '';
    if(!template) return '';
    const display = qs('customerDisplay');
    const name = (display && (display.dataset.name || display.textContent.replace('(Sin seleccionar)','').trim())) || '';
    const doc = (display && display.dataset.document) || '';
    const petSel = qs('pet_id');
    let petName='';
    if(petSel && petSel.selectedIndex >=0){
      const opt = petSel.options[petSel.selectedIndex];
      if(opt && opt.text){ petName = opt.text.split(' (')[0]; }
    }
    const serviceTypeSelect = qs('service_type');
    let serviceType = 'bath';
    let serviceTypeLabel = '';
    if(serviceTypeSelect){
      serviceType = serviceTypeSelect.value || 'bath';
      const opt = serviceTypeSelect.options[serviceTypeSelect.selectedIndex];
      if(opt){ serviceTypeLabel = opt.textContent.trim(); }
    }
    if(!serviceTypeLabel){ serviceTypeLabel = FALLBACK_LABELS[serviceType] || serviceType; }
    return template
      .replace(/{{customer_name}}/g, name)
      .replace(/{{customer_document}}/g, doc)
      .replace(/{{pet_name}}/g, petName)
      .replace(/{{service_type_label}}/g, serviceTypeLabel);
  }

  function fillConsent(){
    const area = qs('consent_text');
    if(!area){ console.warn('[Servicio] Falta #consent_text'); return; }
    const txt = buildConsent();
    if(txt){ area.value = txt; console.debug('[Servicio] Consentimiento rellenado'); }
  }

  function loadPets(){
    const cid = currentCustomerId();
    const sel = qs('pet_id');
    if(!sel) return;
    sel.innerHTML = '<option value="">Cargando...</option>';
    if(!cid){ sel.innerHTML='<option value="">-- Seleccione Mascota --</option>'; return; }
    console.debug('[Servicio] loadPets() para', cid);
    fetch(`/api/pets/by_customer/${cid}`)
      .then(r=>r.json())
      .then(data=>{
        sel.innerHTML = '<option value="">-- Seleccione Mascota --</option>';
        if(!Array.isArray(data) || data.length===0){
          sel.innerHTML = '<option value="">-- Sin mascotas para este cliente --</option>';
          return;
        }
        data.forEach(p=>{
          const opt=document.createElement('option');
          opt.value=p.id; opt.textContent=p.name + (p.breed? ' ('+p.breed+')':'');
          sel.appendChild(opt);
        });
        fillConsent();
      })
      .catch(()=>{ sel.innerHTML='<option value="">Error cargando mascotas</option>'; });
  }

  // onCustomerSelected ya no se usa; setCustomer centraliza la lógica

  function setCustomer(id, name='', doc='', opts={}){
    console.debug('[Servicio] setCustomer()', {id, name, doc, opts});
    const hidden = qs('customer_id');
    const display = qs('customerDisplay');
    if(hidden){ hidden.value = id || ''; }
    if(display){
      if(id){
        display.textContent = name + (doc? ' ('+doc+')':'' );
        display.dataset.name = name || '';
        display.dataset.document = doc || '';
        display.classList.remove('text-muted');
      } else {
        display.textContent = '(Sin seleccionar)';
        display.dataset.name='';
        display.dataset.document='';
        display.classList.add('text-muted');
      }
    }
    window.dispatchEvent(new CustomEvent('customer:selected', { detail:{ id, name, document: doc }}));
    if(id){
      if(opts.force || id === lastPetsCustomerId){
        console.debug('[Servicio] Forzando recarga de mascotas (force o mismo id)');
        loadPets();
      }
    }
  }

  function bind(){
    ['service_type','pet_id'].forEach(id=>{ const el=qs(id); el && el.addEventListener('change', fillConsent); });
    window.addEventListener('customer:selected', e=>{ /* log opcional */ });
    const fillBtn = document.querySelector('[data-action="fill-consent"]');
    if(fillBtn){ fillBtn.addEventListener('click', fillConsent); }
    // Auto precio según tipo
    const serviceTypeSelect = qs('service_type');
    const priceInput = document.querySelector('input[name="price"]');
    if(serviceTypeSelect && priceInput){
      const applyPrice = () => {
        const opt = serviceTypeSelect.options[serviceTypeSelect.selectedIndex];
        if(!opt) return;
        const mode = opt.dataset.mode;
        const base = parseFloat(opt.dataset.base || '0');
        if(mode === 'fixed'){
          priceInput.value = base.toFixed(2);
          priceInput.readOnly = false; // se podría bloquear si se desea estricto
        } else {
          if((!priceInput.value || parseFloat(priceInput.value) === 0) && base>0){
            priceInput.value = base.toFixed(2);
          }
          priceInput.readOnly = false;
        }
      };
      serviceTypeSelect.addEventListener('change', ()=>{ applyPrice(); fillConsent(); });
      // inicial
      applyPrice();
    }
  }

  function init(){
    console.debug('[Servicio] Inicializando módulo ServiceForm');
  console.debug("[Servicio] Pets renderizados en servidor: count={{ pets|length }} ids={{ pets|map(attribute='id')|list|join(',') }}");
    bind();
    const cid = currentCustomerId();
    if(cid){ lastPetsCustomerId = cid; loadPets(); }
    else { fillConsent(); }

  // Eliminada lógica de sincronización automática: el modal invoca setCustomer()
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else { init(); }

  return { fillConsent, loadPets, setCustomer };
})();
</script>
{% endblock %}
{% block content %}
<form method="post" class="row g-3">
  <div class="col-md-4">
    <label class="form-label d-block">Cliente / Tutor</label>
    <div class="input-group">
      <span id="customerDisplay" data-customer-field="display" class="form-control bg-light {% if not (selected_customer or default_customer) %}text-muted{% endif %}" data-name="{% if selected_customer %}{{ selected_customer.name|e }}{% elif default_customer %}{{ default_customer.name|e }}{% endif %}" data-document="{% if (selected_customer and selected_customer.document) %}{{ selected_customer.document|e }}{% elif (default_customer and default_customer.document) %}{{ default_customer.document|e }}{% endif %}">
        {% if selected_customer %}
          {{ selected_customer.name }}{% if selected_customer.document %} ({{ selected_customer.document }}){% endif %}
        {% elif default_customer %}
          {{ default_customer.name }}{% if default_customer.document %} ({{ default_customer.document }}){% endif %}
        {% else %}
          (Sin seleccionar)
        {% endif %}
      </span>
      <button type="button" class="btn btn-outline-primary" data-open="customer-modal">
        <i class="bi bi-search"></i>
      </button>
    </div>
  <input type="hidden" name="customer_id" id="customer_id" data-customer-field="id" value="{% if selected_customer %}{{ selected_customer.id }}{% elif default_customer %}{{ default_customer.id }}{% endif %}" required>
  </div>
  <div class="col-md-4">
    <label class="form-label">Mascota</label>
  <select name="pet_id" id="pet_id" class="form-select" required>
      <option value="">-- Seleccione Mascota --</option>
      {% if pets %}
        {% for p in pets %}
          <option value="{{ p.id }}">{{ p.name }}{% if p.breed %} ({{ p.breed }}){% endif %}</option>
        {% endfor %}
      {% endif %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Tipo Servicio</label>
  <select name="service_type" id="service_type" class="form-select">
      {% for st in service_types %}
        <option value="{{ st.code }}" data-mode="{{ st.pricing_mode }}" data-base="{{ '%.2f'|format(st.base_price) }}">{{ st.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">Precio</label>
    <input type="number" step="0.01" name="price" class="form-control" required value="0">
  </div>
  <div class="col-md-4">
    <label class="form-label">Técnico / Estilista</label>
    <input type="text" name="technician" class="form-control">
  </div>
  <div class="col-12">
    <label class="form-label">Descripción</label>
    <textarea name="description" class="form-control" rows="2"></textarea>
  </div>
  <div class="col-12">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" role="switch" id="generate_invoice" name="generate_invoice">
      <label class="form-check-label" for="generate_invoice">Generar Factura / Documento</label>
    </div>
  </div>
  <div class="col-12">
    <label class="form-label">Consentimiento Informado</label>
  <textarea name="consent_text" id="consent_text" class="form-control" rows="5" placeholder="Genera el texto usando el botón 'Rellenar' o escribe manualmente"></textarea>
  <input type="hidden" id="consent_template" value="{{ consent_template }}">
  <button type="button" class="btn btn-sm btn-outline-secondary mt-2" data-action="fill-consent">Rellenar</button>
  <small class="text-muted d-block mt-1">Campos: cliente, documento, mascota y tipo servicio se insertan automáticamente.</small>
  </div>
  <div class="col-12">
    <button class="btn btn-primary">Guardar</button>
    <a href="{{ url_for('service_list') }}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>
{% include 'partials/customer_modal.html' %}
{% if current_user.role == 'admin' and service_types %}
<hr>
<div class="card mt-3">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h6 class="mb-0 text-uppercase small">Resumen Tipos de Servicio</h6>
    <a href="{{ url_for('service_type_list') }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-tags"></i> Gestionar</a>
  </div>
  <div class="card-body">
    <div class="row g-2">
      {% for t in service_types %}
      <div class="col-md-4 col-lg-3">
        <div class="border rounded p-2 small h-100 d-flex flex-column justify-content-between">
          <div>
            <strong>{{ t.name }}</strong><br>
            <span class="text-muted">{{ 'Fijo' if t.pricing_mode=='fixed' else 'Variable' }}</span>
          </div>
          <div class="mt-1"><span class="badge bg-{{ 'primary' if t.pricing_mode=='fixed' else 'warning' }}">{{ '$%.0f'|format(t.base_price) }}</span></div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
